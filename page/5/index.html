<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Matrix207&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Matrix207's Blog">
<meta property="og:url" content="http://matrix207.github.com/page/5/index.html">
<meta property="og:site_name" content="Matrix207's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Matrix207's Blog">
<meta name="twitter:description">
  
    <link rel="alternate" href="/atom.xml" title="Matrix207&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Matrix207&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://matrix207.github.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-linux-network-performance-monitor" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/21/linux-network-performance-monitor/" class="article-date">
  <time datetime="2015-01-20T16:00:00.000Z" itemprop="datePublished">2015-01-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/21/linux-network-performance-monitor/">linux network performance monitor</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="ethtool"><a href="#ethtool" class="headerlink" title="ethtool"></a>ethtool</h3><h3 id="iptraf"><a href="#iptraf" class="headerlink" title="iptraf"></a>iptraf</h3><h3 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h3><h3 id="iperf"><a href="#iperf" class="headerlink" title="iperf"></a>iperf</h3><p>Build from source:  </p>
<pre><code>[root@localhost ~]# tar xvf iperf-2.0.5.tar.gz 
...
[root@localhost ~]# cd iperf-2.0.5
[root@localhost iperf-2.0.5]# ./configure 
...
[root@localhost iperf-2.0.5]# make
...
</code></pre><p>On server machine:  </p>
<pre><code>[root@Ustor iperf-2.0.5]# ./src/iperf -s
------------------------------------------------------------
Server listening on TCP port 5001
TCP window size: 85.3 KByte (default)
------------------------------------------------------------
[  4] local 192.16.110.80 port 5001 connected with 192.16.110.50 port 43341
[ ID] Interval       Transfer     Bandwidth
[  4]  0.0-10.0 sec  9.20 GBytes  7.90 Gbits/sec
[  5] local 192.16.110.80 port 5001 connected with 192.16.110.50 port 43342
[  5]  0.0-10.0 sec  9.26 GBytes  7.95 Gbits/sec
[  4] local 192.16.110.80 port 5001 connected with 192.16.110.50 port 43343
[  4]  0.0-10.0 sec  8.98 GBytes  7.71 Gbits/sec
</code></pre><p>On Client machine:  </p>
<pre><code>[root@localhost iperf-2.0.5]# ./src/iperf -c 192.16.110.80 -f M -i 2
------------------------------------------------------------
Client connecting to 192.16.110.80, TCP port 5001
TCP window size: 0.02 MByte (default)
------------------------------------------------------------
[  3] local 192.16.110.50 port 43343 connected with 192.16.110.80 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0- 2.0 sec  1598 MBytes   799 MBytes/sec
[  3]  2.0- 4.0 sec  1919 MBytes   960 MBytes/sec
[  3]  4.0- 6.0 sec  1892 MBytes   946 MBytes/sec
[  3]  6.0- 8.0 sec  1894 MBytes   947 MBytes/sec
[  3]  8.0-10.0 sec  1893 MBytes   947 MBytes/sec
[  3]  0.0-10.0 sec  9196 MBytes   920 MBytes/sec
</code></pre><ul>
<li>通用参数<ul>
<li>-f [k|m|K|M] 分别表示以Kbits, Mbits, KBytes, MBytes显示报告，默认以Mbits为单位,eg:iperf -c 222.35.11.23 -f K</li>
<li>-i sec 以秒为单位显示报告间隔，eg:iperf -c 222.35.11.23 -i 2</li>
<li>-l 缓冲区大小，默认是8KB,eg:iperf -c 222.35.11.23 -l 16</li>
<li>-m 显示tcp最大mtu值</li>
<li>-o 将报告和错误信息输出到文件eg:iperf -c 222.35.11.23 -o c:\iperflog.txt</li>
<li>-p 指定服务器端使用的端口或客户端所连接的端口eg:iperf -s -p 9999;iperf -c 222.35.11.23 -p 9999</li>
<li>-u 使用udp协议,测试htb的时候最好用udp，udp通信开销小，测试的带宽更准确</li>
<li>-w 指定TCP窗口大小，默认是8KB.如果窗口太小，有可能丢包</li>
<li>-B 绑定一个主机地址或接口（当主机有多个地址或接口时使用该参数）</li>
<li>-C 兼容旧版本（当server端和client端版本不一样时使用）</li>
<li>-M 设定TCP数据包的最大mtu值</li>
<li>-N 设定TCP不延时</li>
<li>-V 传输ipv6数据包</li>
</ul>
</li>
<li>server专用参数<ul>
<li>-D 以服务方式运行ipserf，eg:iperf -s -D</li>
<li>-R 停止iperf服务，针对-D，eg:iperf -s -R</li>
</ul>
</li>
<li>client端专用参数<ul>
<li>-d 同时进行双向传输测试</li>
<li>-n 指定传输的字节数，eg:iperf -c 222.35.11.23 -n 100000</li>
<li>-r 单独进行双向传输测试</li>
<li>-b 指定发送带宽，默认是1Mbit/s. 在测试qos的时候，这是最有用的参数。</li>
<li>-t 测试时间，默认10秒,eg:iperf -c 222.35.11.23 -t 5.默认是10s</li>
<li>-F 指定需要传输的文件</li>
<li>-T 指定ttl值 </li>
</ul>
</li>
</ul>
<h3 id="tcpdump-tcptrace"><a href="#tcpdump-tcptrace" class="headerlink" title="tcpdump tcptrace"></a>tcpdump tcptrace</h3><ul>
<li>tcpdump -i eth0</li>
<li>tcpdump -i eth0 host 172.16.30.44 and port 80</li>
<li>tcpdump -U port 3260 -w /tmp/tcpdump.pcap</li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="http://www.vpsee.com/2009/11/linux-system-performance-monitoring-network/" target="_blank" rel="external">Linux性能监测：network</a></li>
<li><a href="http://blog.chinaunix.net/uid-20778443-id-94533.html" target="_blank" rel="external">iperf 使用总结</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2015/01/21/linux-network-performance-monitor/" data-id="cin61d0l30092fyiz1m1ibc81" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-checking-speed-of-network" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/31/checking-speed-of-network/" class="article-date">
  <time datetime="2014-12-30T16:00:00.000Z" itemprop="datePublished">2014-12-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/31/checking-speed-of-network/">checking network speed</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="一次网络性能检查记录"><a href="#一次网络性能检查记录" class="headerlink" title="一次网络性能检查记录"></a>一次网络性能检查记录</h4><ul>
<li><p>开始检查各种信息(网络、cpu,memory,io等)</p>
<pre><code>[root@Ustor ~]# ifconfig
eth0      Link encap:Ethernet  HWaddr 40:16:7E:35:C7:C2  
          inet addr:172.16.130.158  Bcast:0.0.0.0  Mask:255.255.255.0
          inet6 addr: fe80::4216:7eff:fe35:c7c2/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:37825154 errors:0 dropped:0 overruns:0 frame:0
          TX packets:214565 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:2321429968 (2.1 GiB)  TX bytes:226462903 (215.9 MiB)
          Interrupt:16 Memory:dc400000-dc420000 

eth1      Link encap:Ethernet  HWaddr 40:16:7E:35:C7:C3  
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
          Interrupt:17 Memory:dc300000-dc320000 

eth2      Link encap:Ethernet  HWaddr 00:90:FA:6C:E4:0A  
          inet addr:192.16.110.50  Bcast:0.0.0.0  Mask:255.255.255.0
          inet6 addr: fe80::290:faff:fe6c:e40a/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:775026147 errors:0 dropped:1576 overruns:0 frame:0
          TX packets:1032091357 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:892065492548 (830.8 GiB)  TX bytes:1034532529750 (963.4 GiB)

eth3      Link encap:Ethernet  HWaddr 00:90:FA:6C:E4:0E  
          inet6 addr: fe80::290:faff:fe6c:e40e/64 Scope:Link
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:6593 errors:0 dropped:0 overruns:0 frame:0
          TX packets:5748 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:2011976 (1.9 MiB)  TX bytes:345000 (336.9 KiB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:21995 errors:0 dropped:0 overruns:0 frame:0
          TX packets:21995 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:1234012 (1.1 MiB)  TX bytes:1234012 (1.1 MiB)

[root@Ustor ~]# ping 192.16.110.60
PING 192.16.110.60 (192.16.110.60) 56(84) bytes of data.
64 bytes from 192.16.110.60: icmp_seq=1 ttl=128 time=0.147 ms
64 bytes from 192.16.110.60: icmp_seq=2 ttl=128 time=0.197 ms
64 bytes from 192.16.110.60: icmp_seq=3 ttl=128 time=0.195 ms
64 bytes from 192.16.110.60: icmp_seq=4 ttl=128 time=0.173 ms
64 bytes from 192.16.110.60: icmp_seq=5 ttl=128 time=0.197 ms
^C
--- 192.16.110.60 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4079ms
rtt min/avg/max/mdev = 0.147/0.181/0.197/0.026 ms

[root@Ustor ~]# route 
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.16.130.0    *               255.255.255.0   U     0      0        0 eth0
192.16.110.0    *               255.255.255.0   U     0      0        0 eth2
default         192.16.110.1    0.0.0.0         UG    0      0        0 eth2
default         172.16.130.1    0.0.0.0         UG    0      0        0 eth0
[root@Ustor ~]# ethtool -i eth2
driver: be2net
version: 4.1.307r
firmware-version: 10.0.803.19
bus-info: 0000:02:00.0
[root@Ustor ~]# ethtool eth2
Settings for eth2:
    Supported ports: [ FIBRE ]
    Supported link modes:   10000baseT/Full 
    Supports auto-negotiation: No
    Advertised link modes:  Not reported
    Advertised pause frame use: No
    Advertised auto-negotiation: No
    Speed: 10000Mb/s
    Duplex: Full
    Port: FIBRE
    PHYAD: 0
    Transceiver: external
    Auto-negotiation: off
    Supports Wake-on: g
    Wake-on: d
    Link detected: yes
[root@Ustor ~]# iostat 
Linux 2.6.32-279.el6.x86_64 (Ustor)     12/31/2014     _x86_64_    (2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.36    0.00    1.23    1.08    0.00   97.33

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               3.56        45.00        24.38   19491848   10557699
sdb              28.76      1274.39      2100.99  551950065  909958848
dm-0            224.75       639.32      1158.70  276896736  501843480
dm-1            197.05       634.96       941.44  275005928  407746632
dm-2              0.01         0.02         0.85      10001     368272

[root@Ustor ~]# fdisk -l

Disk /dev/sda: 8012 MB, 8012390400 bytes
255 heads, 63 sectors/track, 974 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x53c628b9

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1          26      204800   83  Linux
Partition 1 does not end on cylinder boundary.
/dev/sda2              26         287     2097152   82  Linux swap / Solaris
Partition 2 does not end on cylinder boundary.
/dev/sda3             287         300      102400   83  Linux
Partition 3 does not end on cylinder boundary.
/dev/sda4             300         975     5419224    5  Extended
Partition 4 does not end on cylinder boundary.
/dev/sda5             300         313      102400   83  Linux
/dev/sda6             313         975     5314560   83  Linux

Disk /dev/sdb: 36002.0 GB, 36002026487808 bytes
255 heads, 63 sectors/track, 4376997 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes
Disk identifier: 0x00000000
</code></pre></li>
</ul>
<pre><code>Disk /dev/mapper/r55-i01: 2097.2 GB, 2097152000000 bytes
255 heads, 63 sectors/track, 254964 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes
Disk identifier: 0x2c0893c9


Disk /dev/mapper/r55-i02: 2097.2 GB, 2097152000000 bytes
255 heads, 63 sectors/track, 254964 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes
Disk identifier: 0xcbbcf789


Disk /dev/mapper/r55-ee: 349.5 GB, 349526032384 bytes
255 heads, 63 sectors/track, 42494 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes
Disk identifier: 0x00000000


#### Hard Raid Card ####
[root@Ustor ~]# lspci  
00:00.0 Host bridge: Intel Corporation 2nd Generation Core Processor Family DRAM Controller (rev 09)
00:01.0 PCI bridge: Intel Corporation Xeon E3-1200/2nd Generation Core Processor Family PCI Express Root Port (rev 09)
00:1a.0 USB controller: Intel Corporation 6 Series/C200 Series Chipset Family USB Enhanced Host Controller #2 (rev 05)
00:1c.0 PCI bridge: Intel Corporation 6 Series/C200 Series Chipset Family PCI Express Root Port 1 (rev b5)
00:1c.4 PCI bridge: Intel Corporation 6 Series/C200 Series Chipset Family PCI Express Root Port 5 (rev b5)
00:1c.5 PCI bridge: Intel Corporation 6 Series/C200 Series Chipset Family PCI Express Root Port 6 (rev b5)
00:1d.0 USB controller: Intel Corporation 6 Series/C200 Series Chipset Family USB Enhanced Host Controller #1 (rev 05)
00:1e.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev a5)
00:1f.0 ISA bridge: Intel Corporation C202 Chipset Family LPC Controller (rev 05)
00:1f.2 SATA controller: Intel Corporation 6 Series/C200 Series Chipset Family SATA AHCI Controller (rev 05)
00:1f.3 SMBus: Intel Corporation 6 Series/C200 Series Chipset Family SMBus Controller (rev 05)
01:00.0 RAID bus controller: LSI Logic / Symbios Logic MegaRAID SAS 2108 [Liberator] (rev 05)
02:00.0 Ethernet controller: Emulex Corporation OneConnect 10Gb NIC (be3) (rev 01)
02:00.1 Ethernet controller: Emulex Corporation OneConnect 10Gb NIC (be3) (rev 01)
03:00.0 Ethernet controller: Intel Corporation 82574L Gigabit Network Connection
04:00.0 Ethernet controller: Intel Corporation 82574L Gigabit Network Connection
05:05.0 VGA compatible controller: ASPEED Technology, Inc. ASPEED Graphics Family (rev 10)

[root@Ustor ~]# MegaCli -LdPdInfo -aAll

Adapter #0

Number of Virtual Disks: 1
Virtual Drive: 0 (Target Id: 0)
Name                :r55
RAID Level          : Primary-5, Secondary-0, RAID Level Qualifier-3
Size                : 32.743 TB
Parity Size         : 3.637 TB
State               : Optimal
Strip Size          : 64 KB
Number Of Drives    : 10
Span Depth          : 1
Default Cache Policy: WriteBack, ReadAdaptive, Cached, Write Cache OK if Bad BBU
Current Cache Policy: WriteBack, ReadAdaptive, Cached, Write Cache OK if Bad BBU
Default Access Policy: Read/Write
Current Access Policy: Read/Write
Disk Cache Policy   : Enabled
Encryption Type     : None
Bad Blocks Exist: No
Is VD Cached: No
Number of Spans: 1
Span: 0 - Number of PDs: 10

[root@Ustor ~]# MegaCli -LdPdInfo -aAll |grep -i &apos;raw size&apos;
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]
Raw Size: 3.638 TB [0x1d1c0beb0 Sectors]

#### /dev/sdb的大小是36002GB, 即 36002/1024=35.158TB ####
#### 可是整个raid的大小应该时3.637TB * 9 = 32.733TB才对, 为什么下面/dev/sdb是35.158TB呢 ####
[root@Ustor ~]# fdisk -l /dev/sdb

Disk /dev/sdb: 36002.0 GB, 36002026487808 bytes
255 heads, 63 sectors/track, 4376997 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes
Disk identifier: 0x00000000

[root@Ustor ~]# iostat 1
Linux 2.6.32-279.el6.x86_64 (Ustor)     12/31/2014     _x86_64_    (2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.37    0.00    1.25    1.08    0.00   97.30

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               3.57        46.38        24.39   20146336   10593379
sdb              28.77      1270.72      2136.50  551950697  928014000
dm-0            229.04       637.48      1194.85  276896840  518997016
dm-1            196.74       633.13       940.80  275006032  408647752
dm-2              0.01         0.02         0.85      10169     368768

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00   18.59    0.00    0.00   81.41

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               0.00         0.00         0.00          0          0
sdb              72.00         0.00     24584.00          0      24584
dm-0              0.00         0.00         0.00          0          0
dm-1           3072.00         0.00     24576.00          0      24576
dm-2              1.00         0.00         8.00          0          8

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00   11.50    0.00    0.00   88.50

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               0.00         0.00         0.00          0          0
sdb              37.00         0.00     16400.00          0      16400
dm-0              0.00         0.00         0.00          0          0
dm-1           2048.00         0.00     16384.00          0      16384
dm-2              2.00         0.00        16.00          0         16

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           5.05    0.00   18.69    0.00    0.00   76.26

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               0.00         0.00         0.00          0          0
sdb              72.00         0.00     32768.00          0      32768
dm-0              0.00         0.00         0.00          0          0
dm-1           4096.00         0.00     32768.00          0      32768
dm-2              0.00         0.00         0.00          0          0

#### dd的速度达到1GB/s，说明瓶颈不在磁盘 ####
[root@Ustor ~]# dd if=/dev/zero of=/dev/sdb bs=1M count=102400
28309+0 records in
28309+0 records out
29684137984 bytes (30 GB) copied, 28.4613 s, 1.0 GB/s
33270+0 records in
33270+0 records out
34886123520 bytes (35 GB) copied, 33.4982 s, 1.0 GB/s
38234+0 records in
38234+0 records out
40091254784 bytes (40 GB) copied, 38.5252 s, 1.0 GB/s
^C42879+0 records in
42879+0 records out
44961890304 bytes (45 GB) copied, 43.2484 s, 1.0 GB/s

[root@Ustor ~]# ls /dev/r55/
ee  i01  i02
[root@Ustor ~]# ls /dev/r55/ee -l
lrwxrwxrwx 1 root root 7 Dec 30 16:42 /dev/r55/ee -&gt; ../dm-2
[root@Ustor ~]# dd if=/dev/zero of=/dev/r55/ee bs=1M count=1024000
2552+0 records in
2552+0 records out
2675965952 bytes (2.7 GB) copied, 2.31478 s, 1.2 GB/s
7516+0 records in
7516+0 records out
7881097216 bytes (7.9 GB) copied, 7.34263 s, 1.1 GB/s

[root@Ustor ~]# dd if=/dev/zero of=/dev/r55/i01 bs=1M count=1024000
2869+0 records in
2869+0 records out
3008364544 bytes (3.0 GB) copied, 2.73699 s, 1.1 GB/s
7841+0 records in
7841+0 records out
8221884416 bytes (8.2 GB) copied, 7.76994 s, 1.1 GB/s

[root@Ustor ~]# dd if=/dev/zero of=/dev/r55/i02 bs=1M count=1024000
^[OH2751+0 records in
2751+0 records out
2884632576 bytes (2.9 GB) copied, 2.53248 s, 1.1 GB/s
7704+1 records in
7704+0 records out
8078229504 bytes (8.1 GB) copied, 7.56027 s, 1.1 GB/s

[root@Ustor ~]# blockdev --report /dev/sdb
RO    RA   SSZ   BSZ   StartSec            Size   Device
rw   256   512  4096          0  36002026487808   /dev/sdb
[root@Ustor ~]# blockdev --report /dev/r55/ee 
RO    RA   SSZ   BSZ   StartSec            Size   Device
rw 16384   512  4096          0    349526032384   /dev/r55/ee
[root@Ustor ~]# blockdev --report /dev/r55/i01
RO    RA   SSZ   BSZ   StartSec            Size   Device
rw   256   512  4096          0   2097152000000   /dev/r55/i01
[root@Ustor ~]# blockdev --report /dev/r55/i02
RO    RA   SSZ   BSZ   StartSec            Size   Device
rw   256   512  4096          0   2097152000000   /dev/r55/i0

[root@Ustor ~]# sysctl -a |grep ipv4.tcp
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_retrans_collapse = 1
net.ipv4.tcp_syn_retries = 5
net.ipv4.tcp_synack_retries = 5
net.ipv4.tcp_max_orphans = 131072
net.ipv4.tcp_max_tw_buckets = 131072
net.ipv4.tcp_keepalive_time = 7200
net.ipv4.tcp_keepalive_probes = 9
net.ipv4.tcp_keepalive_intvl = 75
net.ipv4.tcp_retries1 = 3
net.ipv4.tcp_retries2 = 15
net.ipv4.tcp_fin_timeout = 60
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_recycle = 0
net.ipv4.tcp_abort_on_overflow = 0
net.ipv4.tcp_stdurg = 0
net.ipv4.tcp_rfc1337 = 0
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_orphan_retries = 0
net.ipv4.tcp_fack = 1
net.ipv4.tcp_reordering = 3
net.ipv4.tcp_ecn = 2
net.ipv4.tcp_dsack = 1
net.ipv4.tcp_mem = 173856    231808    347712
net.ipv4.tcp_wmem = 4096    16384    4194304
net.ipv4.tcp_rmem = 4096    87380    4194304
net.ipv4.tcp_app_win = 31
net.ipv4.tcp_adv_win_scale = 2
net.ipv4.tcp_tw_reuse = 0
net.ipv4.tcp_frto = 2
net.ipv4.tcp_frto_response = 0
net.ipv4.tcp_low_latency = 0
net.ipv4.tcp_no_metrics_save = 0
net.ipv4.tcp_moderate_rcvbuf = 1
net.ipv4.tcp_tso_win_divisor = 3
net.ipv4.tcp_congestion_control = cubic
net.ipv4.tcp_abc = 0
net.ipv4.tcp_mtu_probing = 0
net.ipv4.tcp_base_mss = 512
net.ipv4.tcp_workaround_signed_windows = 0
net.ipv4.tcp_dma_copybreak = 4096
net.ipv4.tcp_slow_start_after_idle = 1
net.ipv4.tcp_available_congestion_control = cubic reno
net.ipv4.tcp_allowed_congestion_control = cubic reno
net.ipv4.tcp_max_ssthresh = 0
net.ipv4.tcp_thin_linear_timeouts = 0
net.ipv4.tcp_thin_dupack = 0

[root@Ustor ~]# ethtool -k eth2
Offload parameters for eth2:
rx-checksumming: on
tx-checksumming: on
scatter-gather: on
tcp-segmentation-offload: on
udp-fragmentation-offload: off
generic-segmentation-offload: on
generic-receive-offload: off
large-receive-offload: off

[root@Ustor ~]# tcpdump -i eth2 -w /tmp/tcpdump01.pcap
tcpdump: listening on eth2, link-type EN10MB (Ethernet), capture size 65535 bytes
^C154277 packets captured
979189 packets received by filter
824910 packets dropped by kernel
[root@Ustor ~]# ls /tmp/tcpdump01.pcap -lh
-rw-r--r-- 1 root root 187M Dec 31 10:47 /tmp/tcpdump01.pcap
</code></pre><ul>
<li><p>tshark 分析</p>
<pre><code>#### scp下载包到本地，使用tshark分析 ####
[dennis@localhost ~]$ scp root@172.16.130.158:/tmp/tcpdump01.pcap ./
root@172.16.130.158&apos;s password: 
tcpdump01.pcap                         100%  186MB  11.0MB/s   00:17 
[dennis@localhost ~]$ capinfos tcpdump01.pcap 
File name:           tcpdump01.pcap
File type:           Wireshark/tcpdump/... - pcap
File encapsulation:  Ethernet
Packet size limit:   file hdr: 65535 bytes
Number of packets:   154 k
File size:           195 MB
Data size:           192 MB
Capture duration:    40 seconds
Start time:          Wed Dec 31 10:47:13 2014
End time:            Wed Dec 31 10:47:53 2014
Data byte rate:      4,816 kBps
Data bit rate:       38 Mbps
Average packet size: 1249.82 bytes
Average packet rate: 3,853 packets/sec
SHA1:                b08cff272eb5b0d9aa64fb31343314603df44309
RIPEMD160:           70123da08082954af0d91dde9d9766a61c0a93db
MD5:                 0571ac4f35410047a13cdfbd3bf3bfe9
Strict time order:   False

#### 重传好像影响不大? ####
[dennis@localhost ~]$ tshark -n -q -r tcpdump01.pcap  -z &quot;io,stat,0,tcp.analysis.retransmission&quot;

=======================================================
| IO Statistics                                       |
|                                                     |
| Interval size: 40.0 secs (dur)                      |
| Col 1: Frames and bytes                             |
|     2: tcp.analysis.retransmission                  |
|-----------------------------------------------------|
|              |1                   |2                |
| Interval     | Frames |   Bytes   | Frames |  Bytes |
|-----------------------------------------------------|
|  0.0 &lt;&gt; 40.0 | 154277 | 192818724 |    141 | 191110 |
=======================================================
[dennis@localhost ~]$ tshark -n -q -r tcpdump01.pcap  -z &quot;io,stat,0,tcp.analysis.out_of_order&quot;

=======================================================
| IO Statistics                                       |
|                                                     |
| Interval size: 40.0 secs (dur)                      |
| Col 1: Frames and bytes                             |
|     2: tcp.analysis.out_of_order                    |
|-----------------------------------------------------|
|              |1                   |2                |
| Interval     | Frames |   Bytes   | Frames |  Bytes |
|-----------------------------------------------------|
|  0.0 &lt;&gt; 40.0 | 154277 | 192818724 |    620 | 898920 |
=======================================================
[dennis@localhost ~]$ tshark -n -q -r tcpdump01.pcap  -z &quot;io,stat,5,tcp.analysis.out_of_order&quot;

==================================================
| IO Statistics                                  |
|                                                |
| Interval size: 5 secs                          |
| Col 1: Frames and bytes                        |
|     2: tcp.analysis.out_of_order               |
|------------------------------------------------|
|          |1                  |2                |
| Interval | Frames |   Bytes  | Frames |  Bytes |
|------------------------------------------------|
|  0 &lt;&gt;  5 |  10837 | 14246599 |      1 |   1514 |
|  5 &lt;&gt; 10 |  49803 | 61236860 |    184 | 264780 |
| 10 &lt;&gt; 15 |  48890 | 61739426 |    186 | 271384 |
| 15 &lt;&gt; 20 |  42976 | 55481613 |    249 | 361242 |
| 20 &lt;&gt; 25 |    397 |    24870 |      0 |      0 |
| 25 &lt;&gt; 30 |    461 |    29156 |      0 |      0 |
| 30 &lt;&gt; 35 |    488 |    31931 |      0 |      0 |
| 35 &lt;&gt; 40 |    421 |    28029 |      0 |      0 |
| 40 &lt;&gt; 40 |      4 |      240 |      0 |      0 |
==================================================
[dennis@localhost ~]$ tshark -n -q -r tcpdump01.pcap  -z &quot;io,stat,5,tcp.analysis.retransmission&quot;

=================================================
| IO Statistics                                 |
|                                               |
| Interval size: 5 secs                         |
| Col 1: Frames and bytes                       |
|     2: tcp.analysis.retransmission            |
|-----------------------------------------------|
|          |1                  |2               |
| Interval | Frames |   Bytes  | Frames | Bytes |
|-----------------------------------------------|
|  0 &lt;&gt;  5 |  10837 | 14246599 |      3 |  4542 |
|  5 &lt;&gt; 10 |  49803 | 61236860 |     62 | 85484 |
| 10 &lt;&gt; 15 |  48890 | 61739426 |     41 | 53682 |
| 15 &lt;&gt; 20 |  42976 | 55481613 |     35 | 47402 |
| 20 &lt;&gt; 25 |    397 |    24870 |      0 |     0 |
| 25 &lt;&gt; 30 |    461 |    29156 |      0 |     0 |
| 30 &lt;&gt; 35 |    488 |    31931 |      0 |     0 |
| 35 &lt;&gt; 40 |    421 |    28029 |      0 |     0 |
| 40 &lt;&gt; 40 |      4 |      240 |      0 |     0 |
=================================================
[dennis@localhost ~]$ 
</code></pre></li>
</ul>
<ul>
<li><p>会不会网卡驱动有问题?据说这个Emulex卡直接装就可以用，不用单独安装驱动</p>
<pre><code>[root@Ustor ~]# modinfo be2net
filename:       /lib/modules/2.6.32-279.el6.x86_64/kernel/drivers/net/benet/be2net.ko
license:        GPL
author:         ServerEngines Corporation
description:    ServerEngines BladeEngine 10Gbps NIC Driver 4.1.307r
version:        4.1.307r
srcversion:     7076CA6C80C3CD968BAFFFC
alias:          pci:v000010DFd00000720sv*sd*bc*sc*i*
alias:          pci:v000010DFd0000E228sv*sd*bc*sc*i*
alias:          pci:v000010DFd0000E220sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000710sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000700sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000221sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000211sv*sd*bc*sc*i*
depends:        
vermagic:       2.6.32-279.el6.x86_64 SMP mod_unload modversions 
parm:           num_vfs:Number of PCI VFs to initialize (uint)
parm:           multi_rxq:Obsolete and used only for compatibility (bool)
parm:           rx_frag_size:Size of a fragment that holds rcvd data. (ushort)
[root@Ustor ~]# lspci -nn |grep Emulex
02:00.0 Ethernet controller [0200]: Emulex Corporation OneConnect 10Gb NIC (be3) [19a2:0710] (rev 01)
02:00.1 Ethernet controller [0200]: Emulex Corporation OneConnect 10Gb NIC (be3) [19a2:0710] (rev 01)
型号是19a2:0710
[root@Ustor ~]# grep -irn &apos;19a2.*0710&apos; /lib/modules/2.6.32-279.el6.x86_64/modules.alias
3732:alias pci:v000019A2d00000710sv*sd*bc*sc*i* be2net
</code></pre></li>
<li><p>修改磁盘预读大小，性能没什么提升，依然再100MB/s左右，查看windows下的网络曲线，不够平整</p>
<pre><code>[root@Ustor SOURCES]# blockdev --report
RO    RA   SSZ   BSZ   StartSec            Size   Device
rw 16384   512  4096          0      8012390400   /dev/sda
rw 16384   512  1024       2048       209715200   /dev/sda1
rw 16384   512  4096     411648      2147483648   /dev/sda2
rw 16384   512  1024    4605952       104857600   /dev/sda3
rw 16384   512  1024    4810752            1024   /dev/sda4
rw 16384   512  1024    4812800       104857600   /dev/sda5
rw 16384   512  4096    5019648      5442109440   /dev/sda6
rw   256   512  4096          0  36002026487808   /dev/sdb
rw   256   512  4096          0   2097152000000   /dev/dm-0
rw   256   512  4096          0   2097152000000   /dev/dm-1
rw 16384   512  4096          0    349526032384   /dev/dm-2
[root@Ustor SOURCES]# blockdev --setra 16384 /dev/dm-1
[root@Ustor SOURCES]# blockdev --setra 16384 /dev/dm-0
[root@Ustor SOURCES]# blockdev --setra 16384 /dev/sdb
[root@Ustor SOURCES]# blockdev --report
RO    RA   SSZ   BSZ   StartSec            Size   Device
rw 16384   512  4096          0      8012390400   /dev/sda
rw 16384   512  1024       2048       209715200   /dev/sda1
rw 16384   512  4096     411648      2147483648   /dev/sda2
rw 16384   512  1024    4605952       104857600   /dev/sda3
rw 16384   512  1024    4810752            1024   /dev/sda4
rw 16384   512  1024    4812800       104857600   /dev/sda5
rw 16384   512  4096    5019648      5442109440   /dev/sda6
rw 16384   512  4096          0  36002026487808   /dev/sdb
rw 16384   512  4096          0   2097152000000   /dev/dm-0
rw 16384   512  4096          0   2097152000000   /dev/dm-1
rw 16384   512  4096          0    349526032384   /dev/dm-2
</code></pre></li>
</ul>
<p>发现4k;0% read;0% random的速度比1M;0%read;0%random的快，<br>通常都是1M的快。。。<br>4k有10G的25%左右速度，速度曲线相对平整；而1M只有8%左右，而且速度曲线极其不平整；</p>
<ul>
<li><p>使用rmp source编译驱动</p>
<pre><code>rpm -ivh be2net-10.2.470.14-1.src.rpm
cd rpmbuild/SOURCES
tar xvf be2net-10.2.470.14.tar.gz 
cd be2net-10.2.470.14 
make
cp /lib/modules/2.6.32-279.el6.x86_64/kernel/drivers/net/benet/be2net.ko{,.bak}
cp ./be2net.ko /lib/modules/2.6.32-279.el6.x86_64/kernel/drivers/net/benet/be2net.ko
modinfo be2net
reboot
ethtool -i be2net

[root@Ustor be2net-10.2.470.14]# modinfo ./be2net.ko
filename:       ./be2net.ko
supported:      external
license:        GPL
author:         Emulex Corporation
description:    Emulex OneConnect NIC Driver 10.2.470.14
version:        10.2.470.14
srcversion:     DE6CC9D92A3CE9C042DA005
alias:          pci:v000010DFd00000728sv*sd*bc*sc*i*
alias:          pci:v000010DFd00000730sv*sd*bc*sc*i*
alias:          pci:v000010DFd00000720sv*sd*bc*sc*i*
alias:          pci:v000010DFd0000E228sv*sd*bc*sc*i*
alias:          pci:v000010DFd0000E220sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000710sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000700sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000221sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000211sv*sd*bc*sc*i*
depends:        
vermagic:       2.6.32-279.el6.x86_64 SMP mod_unload modversions 
parm:           rss_on_mc:Enable RSS in multi-channel functions with the capability. Disabled by default. (ushort)
parm:           tx_prio:Create priority based TX queues. Disabled by default (uint)
parm:           num_vfs:Number of PCI VFs to initialize (uint)
parm:           rx_frag_size:Size of receive fragment buffer - 2048 (default), 4096 or 8192 (ushort)
parm:           gro:Enable or Disable GRO. Enabled by default (uint)
parm:           emi_canceller:Enable or Disable EMI Canceller. Disabled by default (uint)
</code></pre></li>
<li><p>更新驱动，重启机器</p>
<pre><code>[root@Ustor be2net-10.2.470.14]# cp be2net.ko /lib/modules/2.6.32-279.el6.x86_64/kernel/drivers/net/benet/
[root@Ustor be2net-10.2.470.14]# ls /lib/modules/2.6.32-279.el6.x86_64/kernel/drivers/net/benet/
be2net.ko  be2net.ko.bak
[root@Ustor be2net-10.2.470.14]# modinfo be2net
filename:       /lib/modules/2.6.32-279.el6.x86_64/kernel/drivers/net/benet/be2net.ko
supported:      external
license:        GPL
author:         Emulex Corporation
description:    Emulex OneConnect NIC Driver 10.2.470.14
version:        10.2.470.14
srcversion:     DE6CC9D92A3CE9C042DA005
alias:          pci:v000010DFd00000728sv*sd*bc*sc*i*
alias:          pci:v000010DFd00000730sv*sd*bc*sc*i*
alias:          pci:v000010DFd00000720sv*sd*bc*sc*i*
alias:          pci:v000010DFd0000E228sv*sd*bc*sc*i*
alias:          pci:v000010DFd0000E220sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000710sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000700sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000221sv*sd*bc*sc*i*
alias:          pci:v000019A2d00000211sv*sd*bc*sc*i*
depends:        
vermagic:       2.6.32-279.el6.x86_64 SMP mod_unload modversions 
parm:           rss_on_mc:Enable RSS in multi-channel functions with the capability. Disabled by default. (ushort)
parm:           tx_prio:Create priority based TX queues. Disabled by default (uint)
parm:           num_vfs:Number of PCI VFs to initialize (uint)
parm:           rx_frag_size:Size of receive fragment buffer - 2048 (default), 4096 or 8192 (ushort)
parm:           gro:Enable or Disable GRO. Enabled by default (uint)
parm:           emi_canceller:Enable or Disable EMI Canceller. Disabled by default (uint)
[root@Ustor be2net-10.2.470.14]# modprobe be2net
[root@Ustor be2net-10.2.470.14]# ethtool eth2
Settings for eth2:
    Supported ports: [ FIBRE ]
    Supported link modes:   10000baseT/Full 
    Supports auto-negotiation: No
    Advertised link modes:  Not reported
    Advertised pause frame use: No
    Advertised auto-negotiation: No
    Speed: 10000Mb/s
    Duplex: Full
    Port: FIBRE
    PHYAD: 0
    Transceiver: external
    Auto-negotiation: off
    Supports Wake-on: g
    Wake-on: d
    Link detected: yes
[root@Ustor be2net-10.2.470.14]# ethtool -i eth2
driver: be2net
version: 4.1.307r
firmware-version: 10.0.803.19
bus-info: 0000:02:00.0
[root@Ustor be2net-10.2.470.14]# reboot

Broadcast message from root@Ustor
    (/dev/pts/1) at 15:50 ...
[dennis@localhost ~]$ ssh root@172.16.130.158
root@172.16.130.158&apos;s password: 
Last login: Wed Dec 31 09:32:07 2014 from 172.16.50.39
[root@Ustor ~]# 
[root@Ustor ~]# ethtool -i eth2
driver: be2net
version: 10.2.470.14
firmware-version: 10.0.803.19
bus-info: 0000:02:00.0
[root@Ustor ~]# 
</code></pre></li>
</ul>
<p>重新使用iometer测试看看，是否换了驱动性能有所提升<br>10G网络使用率为65%，速度达到780MB/s左右, 网络速度曲线还算平整  </p>
<p>把驱动还原为旧的版本，在测试一下，如果速度又是100MB/s左右，说明确实是驱动问题。  </p>
<p>经过测试，速度确实又回到100MB/s左右了，看来是驱动问题了。  </p>
<h4 id="关于Emulex万兆网卡测试，性能比较低-只有约100MB-s"><a href="#关于Emulex万兆网卡测试，性能比较低-只有约100MB-s" class="headerlink" title="关于Emulex万兆网卡测试，性能比较低(只有约100MB/s)"></a>关于Emulex万兆网卡测试，性能比较低(只有约100MB/s)</h4><ol>
<li>硬RAID，10块磁盘建raid5，建iscsi卷</li>
<li>windows使用iometer，1M;0%Read;0%Random</li>
<li>网卡驱动be2net从4.1.307r升级到10.2.470.14</li>
</ol>
<p>经检查测试，更新存储机器(172.16.130.158)的驱动版本(网卡驱动be2net从 4.1.307r升级到10.2.470.14) 后</p>
<p>使用iometer(1M;0%Read;0%Random)测试，速度从100MB/s左右提升到780MB/s左右</p>
<p>看起来原系统的Emulex万兆网卡驱动有问题，升级就好了.</p>
<p>驱动下载地址:</p>
<ul>
<li><p><a href="http://www.emulex.cn/downloads/emulex/drivers/linux/rhel-6-centos-6/drivers/" target="_blank" rel="external">http://www.emulex.cn/downloads/emulex/drivers/linux/rhel-6-centos-6/drivers/</a></p>
</li>
<li><p><code>wget http://www-dl.emulex.com/support/elx/rt10.2.9/ga/Linux/driver-source/be2net-10.2.470.14-1.src.rpm</code></p>
</li>
</ul>
<h4 id="总结-很多时候，复杂问题的背后隐藏的是简单的解决方法"><a href="#总结-很多时候，复杂问题的背后隐藏的是简单的解决方法" class="headerlink" title="总结: 很多时候，复杂问题的背后隐藏的是简单的解决方法"></a>总结: 很多时候，复杂问题的背后隐藏的是简单的解决方法</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/12/31/checking-speed-of-network/" data-id="cin61d0l80096fyiztrd89ho4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-network-analyze-with-wireshark" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/26/network-analyze-with-wireshark/" class="article-date">
  <time datetime="2014-12-25T16:00:00.000Z" itemprop="datePublished">2014-12-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/26/network-analyze-with-wireshark/">network analyze with wireshark</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><p>1.过滤IP，如来源IP或者目标IP等于某个IP</p>
<pre><code>例子:
ip.src eq 192.168.1.107 or ip.dst eq 192.168.1.107
或者
ip.addr eq 192.168.1.107 // 都能显示来源IP和目标IP
</code></pre><p>2.过滤端口</p>
<pre><code>例子:
tcp.port eq 80 // 不管端口是来源的还是目标的都显示
tcp.port == 80
tcp.port eq 2722
tcp.port eq 80 or udp.port eq 80
tcp.dstport == 80 // 只显tcp协议的目标端口80
tcp.srcport == 80 // 只显tcp协议的来源端口80
udp.port eq 15000
过滤端口范围
tcp.port &gt;= 1 and tcp.port &lt;= 80
</code></pre><p>3.过滤协议</p>
<pre><code>例子:
tcp
udp
arp
icmp
http
smtp
ftp
dns
msnms
ip
ssl
oicq
bootp
等等
排除arp包，如!arp  或者  not arp
</code></pre><p>4.过滤MAC</p>
<pre><code>太以网头过滤
eth.dst == A0:00:00:04:C5:84 // 过滤目标mac
eth.src eq A0:00:00:04:C5:84 // 过滤来源mac
eth.dst==A0:00:00:04:C5:84
eth.dst==A0-00-00-04-C5-84
eth.addr eq A0:00:00:04:C5:84 // 过滤来源MAC和目标MAC都等于A0:00:00:04:C5:84的
less than 小于 &lt; lt
小于等于 le
等于 eq
大于 gt
大于等于 ge
不等 ne
</code></pre><p>5.包长度过滤</p>
<pre><code>例子:
udp.length == 26 这个长度是指udp本身固定长度8加上udp下面那块数据包之和
tcp.len &gt;= 7  指的是ip数据包(tcp下面那块数据),不包括tcp本身
ip.len == 94 除了以太网头固定长度14,其它都算是ip.len,即从ip本身到最后
frame.len == 119 整个数据包长度,从eth开始到最后
eth —&gt; ip or arp —&gt; tcp or udp —&gt; data
</code></pre><p>6.http模式过滤</p>
<pre><code>例子:
http.request.method == GET
http.request.method == POST
http.request.uri == /img/logo-edu.gif
http contains GET
http contains HTTP/1.
// GET包
http.request.method == GET &amp;&amp; http contains Host:
http.request.method == GET &amp;&amp; http contains User-Agent:
// POST包
http.request.method == POST &amp;&amp; http contains Host:
http.request.method == POST &amp;&amp; http contains User-Agent:
// 响应包
http contains HTTP/1.1 200 OK &amp;&amp; http contains Content-Type:
http contains HTTP/1.0 200 OK &amp;&amp; http contains Content-Type:
一定包含如下
Content-Type:
</code></pre><p>7.TCP参数过滤</p>
<pre><code>tcp.flags 显示包含TCP标志的封包。
tcp.flags.syn == 0×02    显示包含TCP SYN标志的封包。
tcp.window_size == 0 &amp;&amp; tcp.flags.reset != 1
</code></pre><p>8.过滤内容</p>
<pre><code>tcp[20]表示从20开始，取1个字符
tcp[20:]表示从20开始，取1个字符以上
tcp[20:8]表示从20开始，取8个字符
tcp[offset,n]
udp[8:3]==81:60:03 // 偏移8个bytes,再取3个数，是否与==后面的数据相等？
udp[8:1]==32  如果我猜的没有错的话，应该是udp[offset:截取个数]=nValue
eth.addr[0:3]==00:06:5B

例子:
判断upd下面那块数据包前三个是否等于0×20 0×21 0×22
我们都知道udp固定长度为8
udp[8:3]==20:21:22
判断tcp那块数据包前三个是否等于0×20 0×21 0×22
tcp一般情况下，长度为20,但也有不是20的时候
tcp[8:3]==20:21:22
如果想得到最准确的，应该先知道tcp长度
matches(匹配)和contains(包含某字符串)语法
ip.src==192.168.1.107 and udp[8:5] matches x02x12x21x00x22
ip.src==192.168.1.107 and udp contains 02:12:21:00:22
ip.src==192.168.1.107 and tcp contains GET
udp contains 7c:7c:7d:7d 匹配payload中含有0x7c7c7d7d的UDP数据包，不一定是从第一字节匹配。

例子:
得到本地qq登陆数据包(判断条件是第一个包==0×02,第四和第五个包等于0x00x22,最后一个包等于0×03)
0×02 xx xx 0×00 0×22 … 0×03
正确
oicq and udp[8:] matches ^x02[x00-xff][x00-xff]x00x22[x00-xff]+x03$
oicq and udp[8:] matches ^x02[x00-xff]{2}x00x22[x00-xff]+x03$ // 登陆包
oicq and (udp[8:] matches ^x02[x00-xff]{2}x03$ or tcp[8:] matches ^x02[x00-xff]{2}x03$)
oicq and (udp[8:] matches ^x02[x00-xff]{2}x00x22[x00-xff]+x03$ or tcp[20:] matches ^x02[x00-xff]{2}x00x22[x00-xff]+x03$)
不单单是00:22才有QQ号码,其它的包也有,要满足下面条件(tcp也有，但没有做):
oicq and udp[8:] matches ^x02[x00-xff]+x03$ and !(udp[11:2]==00:00) and !(udp[11:2]==00:80)
oicq and udp[8:] matches ^x02[x00-xff]+x03$ and !(udp[11:2]==00:00) and !(udp[15:4]==00:00:00:00)
说明:
udp[15:4]==00:00:00:00 表示QQ号码为空
udp[11:2]==00:00 表示命令编号为00:00
udp[11:2]==00:80 表示命令编号为00:80
当命令编号为00:80时，QQ号码为00:00:00:00
得到msn登陆成功账号(判断条件是USR 7 OK ,即前三个等于USR，再通过两个0×20，就到OK,OK后面是一个字符0×20,后面就是mail了)
USR xx OK mail@hotmail.com
正确
msnms and tcp and ip.addr==192.168.1.107 and tcp[20:] matches ^USRx20[x30-x39]+x20OKx20[x00-xff]+
</code></pre><p>9.dns模式过滤</p>
<p>10.DHCP</p>
<pre><code>以寻找伪造DHCP服务器为例，介绍Wireshark的用法。在显示过滤器中加入过滤规则，
显示所有非来自DHCP服务器并且bootp.type==0×02（Offer/Ack）的信息：
bootp.type==0×02 and not ip.src==192.168.1.1
</code></pre><p>11.msn</p>
<pre><code>msnms &amp;&amp; tcp[23:1] == 20 // 第四个是0×20的msn数据包
msnms &amp;&amp; tcp[20:1] &gt;= 41 &amp;&amp; tcp[20:1] &lt;= 5A &amp;&amp; tcp[21:1] &gt;= 41 &amp;&amp; tcp[21:1] &lt;= 5A &amp;&amp; tcp[22:1] &gt;= 41 &amp;&amp; tcp[22:1] &lt;= 5A
msnms &amp;&amp; tcp[20:3]==USR // 找到命令编码是USR的数据包
msnms &amp;&amp; tcp[20:3]==MSG // 找到命令编码是MSG的数据包
tcp.port == 1863 || tcp.port == 80
如何判断数据包是含有命令编码的MSN数据包?
1)端口为1863或者80,如:tcp.port == 1863 || tcp.port == 80
2)数据这段前三个是大写字母,如:
  tcp[20:1] &gt;= 41 &amp;&amp; tcp[20:1] &lt;= 5A &amp;&amp; tcp[21:1] &gt;= 41 &amp;&amp; tcp[21:1] &lt;= 5A &amp;&amp; tcp[22:1] &gt;= 41 &amp;&amp; tcp[22:1] &lt;= 5A
3)第四个为0×20,如:tcp[23:1] == 20
4)msn是属于TCP协议的,如tcp
</code></pre><h4 id="case-1"><a href="#case-1" class="headerlink" title="case 1"></a>case 1</h4><ul>
<li>1， “业务突然变慢，客户端（确定）和服务端（应该）都没有改动。”  </li>
</ul>
<p>[沛满]：如果怀疑是网络有问题，可以在业务慢的时候抓个500MB左右的网络包分析一下。<br>论坛可以上传的话我也可以帮忙分析。</p>
<ul>
<li>2，“在wireshark上，如何方便查一个tcp报对应的响应包（或响应包对应的原始包）。可<br>以手工根据sequence id和ack id来判断，但是wireshark提供方便的工具么？—-我们的业<br>务是在一个tcp长连接中发很多包。”</li>
</ul>
<p>[沛满]：这个要从基本原理讲起。TCP的工作方式不是逐个包发送的，而是一口气发出多个包<br>，从而提高传输效率。就像快递员会一次性携带很多包裹到我司前台一样，为的是减少消耗<br>在路上的往返时间。接收方收到这些包之后有两个选择，既可以每个包都确认（也就是你提<br>到的响应），也可以只确认最后一个来暗示所有包都收到了。举个例子，发送方发出了10个<br>包，编号1至10，且没有一个丢失的，那接收方既可以回复10个确认包，也可以只回复“ack 11”，<br>表示10以及10之前的所有包都收到了。当有丢包发生时，比如还是发送了10个包的情况，编号<br>也是1至10，但其中10号包丢失了，那接收方可以回复9个确认包，也可以只回复“ack 10”，<br>表示9以及9之前的包都收到了。</p>
<p>了解了这个原理，我们就知道在Wireshark上没有必要去对应每个ack和seq，因为大多数包即<br>便正常收到后也不会有ack。</p>
<ul>
<li>3，“有没有技巧可以方便的统计延时的情况，例如某时间段中，发包到收到ack的延时超过1s的数据包数量？”</li>
</ul>
<p>[沛满]：如果你只是想了解网络延时状况，那用ping最简单准确了，没有必要用Wireshark。<br>一般我们在乎的是应用层的延时，比如向一个服务器发送读请求，到收到读响应的时间差究竟<br>有多少。Wireshark上有提供这个功能，比如CIFS协议那就可以用“smb.time &gt; 1”来过滤出所<br>有超过一秒钟的延时的CIFS操作。如果是NFS，就用rpc.time（因为NFS是基于RPC的协议）。<br>HTTP也有http.time。</p>
<ul>
<li>4，“有没有技巧可以方便的统计丢包的情况，例如某时间段中，发出去的包没收到ack的有多少？”</li>
</ul>
<p>[沛满]：还是那句话，没有收到ack不一定是丢包了。如果是想看丢包重传的统计，那就<br>Analyze–&gt;Expert Info，然后看warnings or notes tab. 虽然要统计出结果很容易，不过<br>使用者需要理解tcp的基础知识才能解读这个结果，比如一个超时重传，导致的后果远远超过<br>一个快速重传。有启用SACK的时候，处理多个丢包的效率远高于没有启用SACK的……这个说起来太复杂了</p>
<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><ul>
<li><a href="https://community.emc.com/thread/194901" target="_blank" rel="external">一站式学习Wireshark</a></li>
<li><a href="http://ninecmd.com/archives/97?replytocom=5" target="_blank" rel="external">WireShark 过滤语法</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/12/26/network-analyze-with-wireshark/" data-id="cin61d0l10091fyiz96lxdqg6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-implement-a-netdisk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/12/how-to-implement-a-netdisk/" class="article-date">
  <time datetime="2014-12-11T16:00:00.000Z" itemprop="datePublished">2014-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/12/how-to-implement-a-netdisk/">how to implement a netdisk</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h3><h3 id="Function-list"><a href="#Function-list" class="headerlink" title="Function list"></a>Function list</h3><ol>
<li>File upload</li>
<li>File download</li>
<li>File list</li>
<li>File share</li>
<li>File classification</li>
<li>offline download</li>
</ol>
<h3 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h3><h3 id="Component-implement"><a href="#Component-implement" class="headerlink" title="Component implement"></a>Component implement</h3><h3 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h3><ol>
<li>File Reduplication</li>
</ol>
<h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="http://open.qiniudn.com/my-road-of-cloud-storage.pdf" target="_blank" rel="external">我的存储之路</a></li>
<li><a href="http://www.zhihu.com/question/21591490" target="_blank" rel="external">网盘(云盘)的大空间是如何实现的?</a></li>
<li><a href="http://www.zte.com.cn/cn/products/cocloud/application/201208/t20120810_341895.html" target="_blank" rel="external">云盘 ZXCLOUD iSpace</a></li>
<li><a href="http://u.wems.net/index.html" target="_blank" rel="external">USpace</a></li>
<li><a href="http://wenku.baidu.com/link?url=TN-CFldzfea0lwlY-j6cnpgfzuJlA31AV2td16qFni_0BvIea-_izUSroc5sd-4xxRv2HriEQbcYsa8xb8XiHDxzlr4kMZPwkdaYe_vt63m" target="_blank" rel="external">USpace产品介绍</a></li>
<li><a href="http://501565246-qq-com.iteye.com/blog/1738716" target="_blank" rel="external">云存储之网盘浅析</a></li>
<li><a href="http://developer.baidu.com/wiki/index.php?title=docs/cplat/bcs/sdk" target="_blank" rel="external">百度云存储SDK及工具</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/12/12/how-to-implement-a-netdisk/" data-id="cin61d0l00090fyizsa52bq4w" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-fix-nic-name-confusion" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/08/how-to-fix-nic-name-confusion/" class="article-date">
  <time datetime="2014-12-07T16:00:00.000Z" itemprop="datePublished">2014-12-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/08/how-to-fix-nic-name-confusion/">how to fix NIC name confusion</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h4><p>list some text from command <code>dmesg</code>:  </p>
<pre><code>792 igb 0000:02:00.0: Intel(R) Gigabit Ethernet Network Connection
793 igb 0000:02:00.0: eth0: (PCIe:2.5GT/s:Width x1)
794 igb 0000:02:00.0: eth0: MAC: 00:1e:67:58:cc:b8
795 igb 0000:02:00.0: eth0: PBA No: 009000-000
796 igb 0000:02:00.0: LRO is disabled
797 igb 0000:02:00.0: Using MSI-X interrupts. 1 rx queue(s), 1 tx queue(s)
798 igb 0000:03:00.0: PCI INT A -&gt; GSI 18 (level, low) -&gt; IRQ 18
799 igb 0000:03:00.0: setting latency timer to 64
800   alloc irq_desc for 32 on node -1
801   alloc kstat_irqs on node -1
802 igb 0000:03:00.0: irq 32 for MSI/MSI-X
803   alloc irq_desc for 33 on node -1
804   alloc kstat_irqs on node -1
805 igb 0000:03:00.0: irq 33 for MSI/MSI-X
806 igb 0000:03:00.0: Intel(R) Gigabit Ethernet Network Connection
807 igb 0000:03:00.0: eth1: (PCIe:2.5GT/s:Width x1)
808 igb 0000:03:00.0: eth1: MAC: 00:1e:67:58:cc:b9
809 igb 0000:03:00.0: eth1: PBA No: 009000-000
810 igb 0000:03:00.0: LRO is disabled
811 igb 0000:03:00.0: Using MSI-X interrupts. 1 rx queue(s), 1 tx queue(s)
812 udev: renamed network interface eth0 to eth2
813 udev: renamed network interface eth1 to eth3
</code></pre><p>we can see that, interface name is eth0 and eth1 at the begin, then udev rename them.  </p>
<p>why?</p>
<h4 id="Checking-and-fix"><a href="#Checking-and-fix" class="headerlink" title="Checking and fix"></a>Checking and fix</h4><p>check the rule of udev:</p>
<pre><code>[root@Ustor network]# cat /etc/udev/rules.d/70-persistent-net.rules
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR{address}==&quot;00:25:90:d7:be:b4&quot;, ATTR{type}==&quot;1&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth0&quot;
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR{address}==&quot;00:25:90:d7:be:b5&quot;, ATTR{type}==&quot;1&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth1&quot;
</code></pre><p>check ip information:  </p>
<pre><code>[root@Ustor network]# ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
    link/ether 00:1e:67:58:cc:b8 brd ff:ff:ff:ff:ff:ff
    inet 172.16.60.220/24 brd 172.16.60.255 scope global eth2
    inet6 fe80::21e:67ff:fe58:ccb8/64 scope link 
       valid_lft forever preferred_lft forever
3: eth3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
    link/ether 00:1e:67:58:cc:b9 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::21e:67ff:fe58:ccb9/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><p>we found that, the mac address from udev rules and <code>ip addr</code> were difference.  </p>
<p>Because udev had defined which NIC used eth0 and eth1, the new NIC(new mac address)<br>should used new interface name(here, using eth2 and eth3).</p>
<p>BTW, I ask the workmate what he had done before this problem occur, he said this<br>os was installed on another board before. That was the problem, the NIC changed,<br>but os not update, so it maded the interface name changed.</p>
<p>Fixed:  </p>
<ol>
<li>update mac address to /etc/udev/rules.d/70-persistent-net.rules.mb2  </li>
<li>reboot  </li>
</ol>
<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/12/08/how-to-fix-nic-name-confusion/" data-id="cin61d0kw008yfyiz7ml86slm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ssd-cache-and-implementation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/04/ssd-cache-and-implementation/" class="article-date">
  <time datetime="2014-12-03T16:00:00.000Z" itemprop="datePublished">2014-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/04/ssd-cache-and-implementation/">ssd cache and implementation</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h4><ul>
<li><p>SSD缓存技术</p>
<ul>
<li>SSD的特性是读速高于写，因此在无盘领域应用SSD时多用作读缓存来使用，SSD缓存源自<br>PXD无盘的SSD二级缓存技术。这里的二级缓存不是指CPU的二级CACHE，而是指应用于无<br>盘架构的第二级读缓存功能。 </li>
<li><a href="http://baike.baidu.com/view/3967982.htm" target="_blank" rel="external">http://baike.baidu.com/view/3967982.htm</a></li>
<li><a href="http://www.searchstorage.com.cn/showcontent_66616.htm" target="_blank" rel="external">http://www.searchstorage.com.cn/showcontent_66616.htm</a></li>
</ul>
</li>
<li><p>快速块设备为较慢的块设备提供缓存</p>
<ul>
<li>Red Hat Enterprise Linux 7.0 中引进让快速块设备作为较慢块设备的缓存的功能作为<br>技术预览。这个功能可让 PCIe SSD 设备作为直接附加存储（DAS）或者存储局域网（SAN）<br>存储的缓存使用，以便提高文件系统性能</li>
<li><a href="https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/7.0_Release_Notes/chap-storage.html" target="_blank" rel="external">Reference</a></li>
</ul>
</li>
</ul>
<h4 id="Facebook-flashcache"><a href="#Facebook-flashcache" class="headerlink" title="Facebook flashcache"></a>Facebook flashcache</h4><p>Flashcache是Facebook技术团队的一个开源项目，最初是为加速MySQL设计。Flashcache通过<br>在文件系统（VFS）和设备驱动之间新增了一次缓存层，来实现对热门数据的缓存。</p>
<p>Flashcache在内核的层次：<br>VFS -&gt; Block层 -&gt; DM层 -&gt; flashcache -&gt; DeviceDriver -&gt; Disk</p>
<p>Flashcache最初的实现是write backup机制cache，后来又加入了write through和write around机制</p>
<pre><code>write backup: 先写入到cahce，然后cache中的脏块会由后台定期刷到持久存储。
write through: 同步写入到cache和持久存储。
write around: 只写入到持久存储。
</code></pre><p>参考:   </p>
<ul>
<li><a href="http://blog.chinaunix.net/uid-26950862-id-3948198.html" target="_blank" rel="external">Flashcache初探</a>  </li>
<li><a href="http://oldblog.donghao.org/2012/12/flashcacheoaiaoippt.html" target="_blank" rel="external">flashcache原理及改造（PPT）</a>  </li>
<li><a href="http://wenku.baidu.com/view/4c37447131b765ce0508142b?refer=&amp;clickSort=download" target="_blank" rel="external">flashcache原理及改造</a>  </li>
</ul>
<h4 id="What-skills-need-to-master"><a href="#What-skills-need-to-master" class="headerlink" title="What skills need to master"></a>What skills need to master</h4><h4 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h4><h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><ul>
<li><a href="http://blog.csdn.net/column/details/flashcache.html" target="_blank" rel="external">linux内核源码阅读之facebook硬盘加速利器flashcache</a></li>
<li><a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&amp;tid=1917560&amp;page=1#pid13842158" target="_blank" rel="external">发几个自己做的关于内核IO方面的ppt</a></li>
<li><a href="https://github.com/facebook/flashcache/" target="_blank" rel="external">flashcache</a>  </li>
<li><a href="http://www.haiyun.me/archives/centos-flashcache.html" target="_blank" rel="external">Centos安装Flashcache使用SSD缓存</a>  </li>
<li><a href="http://blog.csdn.net/kidd_3/article/details/6984822" target="_blank" rel="external">flashcache的实现与分析</a>  </li>
<li><a href="https://awk.so/patents/CN103744624A?cl=zh" target="_blank" rel="external">一种实现存储系统ssd缓存数据选择性升级的系统架构</a>  </li>
<li><a href="http://www.csdn.net/article/2013-10-31/2817357-facebook-flashcache-2010-2013" target="_blank" rel="external">命中率80%，磁盘I/O减半，Flashcache的发展史</a>  </li>
<li><a href="http://cdn.oreillystatic.com/en/assets/1/event/45/Flashcache%20Presentation.pdf" target="_blank" rel="external">FlashCache at Facebook</a>  </li>
<li><a href="http://blog.chinaunix.net/uid-26950862-id-3948198.html" target="_blank" rel="external">Flashcache初探</a>  </li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/12/04/ssd-cache-and-implementation/" data-id="cin61d0ku008xfyiz3wgtzsfy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-lio" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/26/lio/" class="article-date">
  <time datetime="2014-11-25T16:00:00.000Z" itemprop="datePublished">2014-11-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/26/lio/">LIO</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h4><ul>
<li>Linux 2.6.38 为分界线，此前的标准是 Linux SCSI Target , STGT 之后迄今为止的<br>标准是 Linux-IO Target , LIO 确切的说 Linus Torvalds 在 2011年1月15日将<br>LIO SCSI Target engine merge 到 Linux 2.6.38 中</li>
<li>暂时使用LIO作为IET替代，因为IET当前已不更新，最新版2010年。而LIO已进入内核，<br>怎么说这几年应该都会持续发展,属于主流应用。</li>
</ul>
<h4 id="LIO代码量"><a href="#LIO代码量" class="headerlink" title="LIO代码量"></a>LIO代码量</h4><ul>
<li><code>/home/dennis/work/kernel/linux-3.2.63/drivers/target</code></li>
<li><code>[dennis@localhost target]$ find ./* -name &quot;*.*&quot; |xargs wc -l |awk &#39;END{print $1}&#39;</code><br>52187  </li>
<li><code>[dennis@localhost target]$ find iscsi/ -name &quot;*.*&quot; |xargs wc -l |awk &#39;END{print $1}&#39;</code><br>21801  </li>
</ul>
<h4 id="开源iSCSI-Target调研"><a href="#开源iSCSI-Target调研" class="headerlink" title="开源iSCSI Target调研"></a>开源iSCSI Target调研</h4><ul>
<li>SCST与LIO  <ul>
<li>SCST是一个相对较早且比较成熟的SCSI Target开源实现。  </li>
<li>LIO相比SCST是一个更晚的SCSI Target开源实现，但在与SCST竞争进入Linux内核中，<br>却以LIO胜出告终。关于二者之间进入Linux内核时的争论，LWN上一篇很 有趣的文章，<br>A tale of two SCSI Targets，中文翻译为“SCSI Target之 双城记”。  </li>
<li>虽然LIO因为进入Linux内核而有了更好的发展前景，但SCST也不差，Fusion-io 公司<br>刚刚收购了SCST的商业支持公司ID7。</li>
</ul>
</li>
<li>Tgt  <ul>
<li>Tgt也是一个通用的SCST Target开源实现，与前两者不同的是，在支持iSCSI协 议上，<br>Tgt的所有代码是完全工作在用户态的。  </li>
<li>Tgt将LU视为backstore，支持backstore可以模块化，也就是说，你可以写一个模块来<br>支持你自己定义的LU。Tgt提供了多线程api接口，使得编写backstore时 ，可以使用多<br>个线程同时处理SCSI请求。  </li>
<li>Tgt的主线程使用epoll LT模型，监听并接收Initiator发来<br>的读写请求与命令 ，而调用对应的backstore处理模块。</li>
</ul>
</li>
<li>iSCSI Target支持LU是分布式文件系统时的优化  <ul>
<li>iSCSI Target与LU之间支持多连接并发读写请求，对于不要求排序的SCSI命令与数据，可以并发发给LU  </li>
<li>iSCSI Target对SCSI命令与数据进行合并，然后发给LU。  </li>
</ul>
</li>
<li>比较  <ul>
<li>无论是SCST还是LIO，我都不认为它们是支持分布式文件系统的最佳选择。<br>首先，它们都是工作在内核态的，一旦出问题，会导致系统挂掉，直接影响跑在系统上的其他线上服务。<br>其次，SCSI与LIO作为通用的SCSI Target实现，在处理完iSCSI协议后，会把SCSI的<br>处理交给内核SCSI Driver去处理，这对支持分布式文件做二次开发来说，相对更加困难。</li>
<li>LIO对于一个LU，分配一个recv线程与一个send线程，recv线程接收Initiator发来的<br>iSCSI PDU，解析成SCSI请求后交给send线程，send线程将请求发给LU，并将LU返回<br>的结果返回给Initiator。对于LU是分布式文件系统时，一个send线程的框架让支持<br>iSCSI Target与LU之间多连接并发读写相对比较困难。而且LIO对iSCSI协议的支持，<br>很难针对LU是分布式文件系统做优化。LIO的send线程 与recv线程使用一个队列进行<br>通信，该队列中的SCSI请求，有些不关心顺序，有些却关心，这些都是在send线程遍<br>历队列时才进行处理的。如果要支持LU的多连接并发读写，需要额外的队列来维护SCSI<br>请求，这个队列对SCSI请求到达LU的顺序没有要求。当然，也要额外支持多线程等处理。</li>
<li>Tgt由于工作在用户态，没有缺点1，而且Tgt的backstore可以模块化，开发起来非常方便，<br>同时backstore支持多线程处理，而且Tgt交给backstore的多线程处理的 list已经对顺序不作要求了。</li>
<li>从以上分析来看，使用Tgt让分布式文件系统支持iSCSI更加有优势，而且更加方便。<br>目前，开源分布式存储项目sheepdog与hlfs都是基于Tgt开发模块来支持 iSCSI协议的。</li>
</ul>
</li>
<li>Tgt的缺点与改进<ul>
<li>Tgt的backstore在使用多线程时，多个线程竞争一个list，开销较大。可以让 每个线程维护<br>一个list，主线程通过CAS无锁队列的方式，将SCSI请求根据rr算 法加入到每个线程的list中。</li>
<li>Tgt的backstore与LU之间连接数与线程数，是1：1关系，且线程数为4，写死了的。<br>可以修改代码，将连接数改为可配置的。</li>
<li>Tgt使用一个主线程通过epoll接受所有Initiator的读写请求，当登陆的Initiator较多时，<br>这里可能成为瓶颈。通常来说，这不是问题，因为会iSCSI Target会部署多个的。</li>
</ul>
</li>
</ul>
<h3 id="targetcli"><a href="#targetcli" class="headerlink" title="targetcli"></a>targetcli</h3><ul>
<li>root权限运行targetcli</li>
<li>浏览存储对象, ls查看目录树信息，cd到执行目录</li>
<li>创建文件存储对象<ul>
<li>cd /backstores/fileio</li>
<li>create disk0 /tmp/disk0.img 10MB</li>
<li>cd /backstores/ramdisk</li>
<li>create rd0 10MB</li>
</ul>
</li>
<li>创建iSCSI目标<ul>
<li>cd /iscsi </li>
<li>create [这里可以加入自定义的WWN:WorldWide Name]</li>
<li>cd iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e/tpg1/</li>
<li>luns/ create /backstores/fileio/disk0</li>
<li>luns/ create /backstores/ramdisk/rd0</li>
<li>portals/ create 0.0.0.0 </li>
<li>set attribute authentication=0 demo_mode_write_protect=0 generate_node_acls=1 cache_dynamic_acls=1</li>
<li>cd /</li>
<li>ls</li>
<li>saveconfig</li>
</ul>
</li>
<li>当使用targetcli操作完毕后，记得使用saveconfig来保存配置，要不然重启target服务后，<br>刚才的配置将丢失.  <code>targetcli saveconfig</code><br>Last 10 configs saved in /etc/target/backup.<br>Configuration saved to /etc/target/saveconfig.json</li>
<li>启动iscsi target服务<ul>
<li>[root@localhost ~]# service target start </li>
<li>[root@localhost ~]# service target status</li>
</ul>
</li>
<li>装载iSCSI Target <ul>
<li>[root@localhost ~]# iscsiadm -m discovery -t sendtargets -p 127.0.0.1<br>127.0.0.1:3260,1 iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e</li>
<li>[root@localhost ~]# iscsiadm –mode node \  <blockquote>
<p>–targetname iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e \<br>–portal 127.0.0.1 –login</p>
</blockquote>
</li>
<li>上面的命令还可以使用简写模式: iscsiadm -m node -T \<blockquote>
<p>iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e \<br>-p 127.0.0.1 -l</p>
</blockquote>
</li>
<li>[root@localhost dennis]# lsscsi<br>[2:0:0:0]    disk    ATA      ST3160815AS      A     /dev/sda<br>[6:0:0:0]    disk    LIO-ORG  disk0            4.0   /dev/sdb<br>[6:0:0:1]    disk    LIO-ORG  rd0              4.0   /dev/sdc  </li>
</ul>
</li>
<li>卸载并删除iSCSI目标<ul>
<li>iscsiadm –mode node –targetname iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e –portal 127.0.0.1 –logout</li>
<li>或简写: iscsiadm -m node -T iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e -p 127.0.0.1 -u</li>
<li>targetcli iscsi/ delete iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e </li>
</ul>
</li>
<li>Other operation<ul>
<li>iscsiadm –mode node -U all</li>
<li>iscsiadm –mode node -o delete</li>
<li>iscsiadm –mode node</li>
</ul>
</li>
</ul>
<h3 id="测试脚本"><a href="#测试脚本" class="headerlink" title="测试脚本"></a>测试脚本</h3><pre><code>mkdir -p /lio/
targetcli /backstores/fileio create disk0 /lio/disk0.img 1024MB
targetcli /iscsi create iqn.2007-10.lio.com:lio.test
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/luns/ create /backstores/fileio/disk0
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/portals/ create 0.0.0.0 
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1 set attribute authentication=1 demo_mode_write_protect=0 generate_node_acls=1 cache_dynamic_acls=1
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/acls/ create iqn.2007-10.lio.com:acl01
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/acls/iqn.2007-10.lio.com:acl01/ set auth userid=dennis
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/acls/iqn.2007-10.lio.com:acl01/ set auth password=Dennis@123456
targetcli saveconfig
</code></pre><h3 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h3><ul>
<li><p>增加本地监听ip地址和端口</p>
<p>  /iscsi/iqn.20…/tpg1/portals&gt; create 172.16.110.11 8089<br>  Created network portal 172.16.110.11:8089.<br>  /iscsi/iqn.20…/tpg1/portals&gt; ls<br>  o- portals …………………………………………… [Portals: 2]</p>
<pre><code>o- 0.0.0.0:3260 .................................................... [OK]
o- 172.16.110.11:8089 .............................................. [OK]
</code></pre><p>  /iscsi/iqn.20…/tpg1/portals&gt; status<br>  Status for /iscsi/iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e/tpg1/portals: Portals: 2</p>
</li>
<li><p>Initiator访问IP限制? 目前找不到方法！原来的IET有限制指定IP访问的功能，但是并不表示<br>该功能是iscsi协议必须实现的，所以现在的LIO没有这样的功能也是合理的。</p>
</li>
<li><p>如何设置块设备的IO模式为write-back或write-through? 目前找不到方法。对于FILEIO是可以的.</p>
<p>  [root@localhost src]# targetcli /backstores/fileio/ create fileio01.dat /tmp/fileio01.dat 10M write_back=False<br>  Created fileio fileio01.dat with size 10485760<br>  [root@localhost src]# ls /tmp/fileio01.dat -lh<br>  -rw-r–r–. 1 root root 10M Feb  3 15:01 /tmp/fileio01.dat<br>  [root@localhost src]# targetcli /backstores/fileio/ ls<br>  o- fileio ……………………………………………… [Storage Objects: 1]<br>  o- fileio01.dat ………….. [/tmp/fileio01.dat (10.0MiB) write-thru deactivated]<br>  [root@localhost src]# targetcli /backstores/fileio/ create fileio02.dat /tmp/fileio02.dat 10M write_back=True<br>  Created fileio fileio02.dat with size 10485760<br>  [root@localhost src]# targetcli /backstores/fileio/ ls<br>  o- fileio ……………………………………………… [Storage Objects: 2]<br>  o- fileio01.dat ………….. [/tmp/fileio01.dat (10.0MiB) write-thru deactivated]<br>  o- fileio02.dat ………….. [/tmp/fileio02.dat (10.0MiB) write-back deactivated]  </p>
</li>
<li><p>targetcli 设置CHAP登陆: acls中创建wwn, 设置用户名和密码</p>
<ul>
<li>/&gt; cd /iscsi/iqn.2007-10.lio.com:dg2.lv1/tpg1/</li>
<li>set attribute authentication=1</li>
<li>acls/ create iqn.1991-05.com.microsoft:ibm-t410s </li>
<li>cd acls/iqn.1991-05.com.microsoft:ibm-t410s</li>
<li>set auth userid=iqn.1991-05.com.microsoft:ibm-t410s</li>
<li>set auth password=mytargetsecret</li>
<li>saveconfig</li>
<li><p>reference <a href="http://linux-iscsi.org/wiki/ISCSI" target="_blank" rel="external">http://linux-iscsi.org/wiki/ISCSI</a></p>
<p>[root@localhost dennis]# iscsiadm -m node -p 172.16.130.200 -l<br>Logging in to [iface: default, target: iqn.2007-10.lio.com:dg2.lv1, portal: 172.16.130.200,3260] (multiple)<br>iscsiadm: Could not login to [iface: default, target: iqn.2007-10.lio.com:dg2.lv1, portal: 172.16.130.200,3260].<br>iscsiadm: initiator reported error (24 - iSCSI login failed due to authorization failure)<br>iscsiadm: Could not log into all portals</p>
</li>
</ul>
</li>
</ul>
<h3 id="配置检查"><a href="#配置检查" class="headerlink" title="配置检查"></a>配置检查</h3><ul>
<li><p>/sys/kernel/config/target/iscsi/ </p>
<p>  [root@localhost ~]# ls -l /sys/kernel/config/target/iscsi<br>  total 0<br>  drwxr-xr-x. 2 root root    0 Dec 15 15:59 discovery_auth<br>  drwxr-xr-x. 4 root root    0 Dec 15 15:58 iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.f264093a034e<br>  drwxr-xr-x. 4 root root    0 Dec 15 15:59 iqn.2014-12.org.linux-iscsi.localhost.x8664:sn.f3849a0b356e<br>  -r–r–r–. 1 root root 4096 Dec 15 16:05 lio_version</p>
</li>
<li><p>当使用targetcli操作完毕后，记得使用saveconfig来保存配置，要不然重启target服务后，<br>刚才的配置将丢失.</p>
<p>  [root@localhost ~]# targetcli saveconfig<br>  Last 10 configs saved in /etc/target/backup.<br>  Configuration saved to /etc/target/saveconfig.json</p>
</li>
<li><p>关于配置文件 /etc/target/saveconfig.json的解析</p>
<ul>
<li>JSON (JavaScript Object Notation) is a lightweight data-interchange format</li>
<li>JSON 一种轻量级的数据交换格式</li>
<li><a href="http://www.json.org/" target="_blank" rel="external">http://www.json.org/</a></li>
</ul>
</li>
</ul>
<h4 id="需要验证测试的特性"><a href="#需要验证测试的特性" class="headerlink" title="需要验证测试的特性"></a>需要验证测试的特性</h4><ul>
<li>各中类型的性能比较<ul>
<li>FILEIO 性能</li>
<li>Block 性能</li>
</ul>
</li>
<li>增加或删除不用的lun是否需要重启服务，会不会影响正常业务</li>
<li>破坏性测试<ul>
<li>块设备异常是否影响其他iscsi卷的业务</li>
</ul>
</li>
<li>相比IET，有哪些新特性</li>
<li>对比所有TARGET的开源实现，有哪些优势，有无缺点</li>
</ul>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://www.ibm.com/developerworks/community/blogs/5144904d-5d75-45ed-9d2b-cf1754ee936a/entry/linux_io_target%e4%bb%8b%e7%bb%8d_%e4%b8%80?lang=en" target="_blank" rel="external">Linux-IO Target介绍(一)</a></li>
<li><a href="https://www.ibm.com/developerworks/community/blogs/5144904d-5d75-45ed-9d2b-cf1754ee936a/entry/april_11_2014_12_58_am?lang=en" target="_blank" rel="external">Linux-IO Target介绍(二)</a></li>
<li><a href="http://blog.csdn.net/load2006/article/details/18088445" target="_blank" rel="external">LIO target</a></li>
<li><a href="http://linux-iscsi.org/wiki/LIO" target="_blank" rel="external">LIO</a></li>
<li><a href="http://linux-iscsi.org/wiki/ISCSI" target="_blank" rel="external">ISCSI</a></li>
<li><a href="https://en.wikipedia.org/wiki/LIO_(SCSI_target" target="_blank" rel="external">LIO wikipedia</a>)</li>
<li><a href="http://linux-iscsi.org/wiki/Features" target="_blank" rel="external">Linux SCSI Target Features</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/11/26/lio/" data-id="cin61d0kz008zfyizrf2ww084" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-rapidly-method-for-clean-directory-with-rsync" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/09/15/rapidly-method-for-clean-directory-with-rsync/" class="article-date">
  <time datetime="2014-09-14T16:00:00.000Z" itemprop="datePublished">2014-09-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/15/rapidly-method-for-clean-directory-with-rsync/">Rapidly method for clean directory with rsync</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h3><ul>
<li>rm</li>
<li>rsync</li>
</ul>
<h3 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h3><pre><code>[dennis@localhost ttt]$ mkdir empty
[dennis@localhost ttt]$ mkdir tmp/; seq 1 40000 | xargs -I{} touch tmp/file_{} 
[dennis@localhost ttt]$ mkdir tmp1/; time seq 1 40000 | xargs -I{} touch tmp1/file_{} 

real    0m28.781s
user    0m0.361s
sys    0m3.091s
[dennis@localhost ttt]$ ls -ld *
drwxrwxr-x. 2 dennis dennis    4096 Sep 15 09:07 empty
drwxrwxr-x. 2 dennis dennis 1114112 Sep 15 09:11 tmp
drwxrwxr-x. 2 dennis dennis 1114112 Sep 15 09:13 tmp1
[dennis@localhost ttt]$ strace -c rsync -a --delete empty/ tmp/
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 98.91    0.001000         100        10         1 select
  1.09    0.000011           2         6         3 wait4
  0.00    0.000000           0        15           read
  0.00    0.000000           0         5           write
  0.00    0.000000           0        21         9 open
  0.00    0.000000           0        20           close
  0.00    0.000000           0         5         3 stat
  0.00    0.000000           0        12           fstat
  0.00    0.000000           0         1           lstat
  0.00    0.000000           0        25           mmap
  0.00    0.000000           0        12           mprotect
  0.00    0.000000           0         6           munmap
  0.00    0.000000           0         6           brk
  0.00    0.000000           0        10           rt_sigaction
  0.00    0.000000           0         1           rt_sigprocmask
  0.00    0.000000           0         1         1 rt_sigreturn
  0.00    0.000000           0         1         1 access
  0.00    0.000000           0         4           socket
  0.00    0.000000           0         4         4 connect
  0.00    0.000000           0         2           socketpair
  0.00    0.000000           0         1           clone
  0.00    0.000000           0         1           execve
  0.00    0.000000           0        11           fcntl
  0.00    0.000000           0         4           getdents
  0.00    0.000000           0         1           getcwd
  0.00    0.000000           0         1           chdir
  0.00    0.000000           0         2           umask
  0.00    0.000000           0         1           geteuid
  0.00    0.000000           0         1           getegid
  0.00    0.000000           0         1           arch_prctl
  0.00    0.000000           0         2           openat
------ ----------- ----------- --------- --------- ----------------
100.00    0.001011                   193        22 total
[dennis@localhost ttt]$ strace -c rm -rf tmp1/
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 79.25    0.035329           1     40001           unlinkat
 17.50    0.007800         186        42           getdents
  3.07    0.001369           7       196           brk
  0.18    0.000082          21         4           munmap
  0.00    0.000000           0         2           read
  0.00    0.000000           0         8         4 open
  0.00    0.000000           0        10           close
  0.00    0.000000           0         4         3 stat
  0.00    0.000000           0         6           fstat
  0.00    0.000000           0         1           lstat
  0.00    0.000000           0         1         1 lseek
  0.00    0.000000           0        11           mmap
  0.00    0.000000           0         4           mprotect
  0.00    0.000000           0         1           ioctl
  0.00    0.000000           0         1         1 access
  0.00    0.000000           0         1           execve
  0.00    0.000000           0         9           fcntl
  0.00    0.000000           0         1           fstatfs
  0.00    0.000000           0         1           arch_prctl
  0.00    0.000000           0         2           openat
  0.00    0.000000           0         1           newfstatat
------ ----------- ----------- --------- --------- ----------------
100.00    0.044580                 40307         9 total
</code></pre><h3 id="Analyze-system-call"><a href="#Analyze-system-call" class="headerlink" title="Analyze system call"></a>Analyze system call</h3><ul>
<li><p>rm<br>Do so many system calls, special of unlinkat, it take of 79.25% of time,   </p>
</li>
<li><p>rsync  </p>
</li>
</ul>
<h3 id="Analyze-source-code"><a href="#Analyze-source-code" class="headerlink" title="Analyze source code"></a>Analyze source code</h3><ul>
<li><a href="http://rsync.samba.org/" target="_blank" rel="external">rsync</a></li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="http://www.quora.com/How-can-someone-rapidly-delete-400-000-files" target="_blank" rel="external">How can someone rapidly delete 400,000 files?</a></li>
<li><a href="http://blog.chinaunix.net/uid-10705106-id-3879288.html" target="_blank" rel="external">为什么rsync能够快速删除400000文件</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/09/15/rapidly-method-for-clean-directory-with-rsync/" data-id="cin61d0kr008sfyizsk38a9u9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-linux-performace-tools" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/09/08/linux-performace-tools/" class="article-date">
  <time datetime="2014-09-07T16:00:00.000Z" itemprop="datePublished">2014-09-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/08/linux-performace-tools/">linux performace tools</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>###</p>
<p><img src="/assets/image/posts/perf/linux_benchmarking_tools.png" alt="linux benchmarking tools"></p>
<p><img src="/assets/image/posts/perf/linux_observability_sar.png" alt="linux observability sar"></p>
<p><img src="/assets/image/posts/perf/linux_tuning_tools.png" alt="linux tuning tools"></p>
<h3 id="Tools-Basic"><a href="#Tools-Basic" class="headerlink" title="Tools: Basic"></a>Tools: Basic</h3><ul>
<li>uptime</li>
<li>top or htop</li>
<li>mpstat</li>
<li>iostat</li>
<li>vmstat</li>
<li>free </li>
<li>ping</li>
<li>nicstat</li>
<li>dstat</li>
</ul>
<h3 id="Tools-Intermediate"><a href="#Tools-Intermediate" class="headerlink" title="Tools: Intermediate"></a>Tools: Intermediate</h3><ul>
<li>sar</li>
<li>netstat</li>
<li>pidstat</li>
<li>strace</li>
<li>tcpdump</li>
<li>blktrace</li>
<li>iotop</li>
<li>slabtop</li>
<li>sysctl</li>
<li>/proc</li>
</ul>
<h3 id="Tools-Advanced"><a href="#Tools-Advanced" class="headerlink" title="Tools: Advanced"></a>Tools: Advanced</h3><ul>
<li>perf<ul>
<li><code>perf record program [program_option]</code></li>
<li><code>perf report</code></li>
</ul>
</li>
<li>DTrace</li>
<li>SystemTap</li>
<li>and more…<ul>
<li>ps</li>
<li>pmap</li>
<li>traceroute</li>
<li>ntop</li>
<li>ss</li>
<li>lsof</li>
<li>oprofile</li>
<li>gprof</li>
<li>kcachegrind</li>
<li>valgrind</li>
<li>google profiler</li>
<li>nfsiostat</li>
<li>cifsiostat</li>
<li>latencytop</li>
<li>powertop</li>
<li>LLTng</li>
<li>ktap</li>
</ul>
</li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="http://www.brendangregg.com/linuxperf.html" target="_blank" rel="external">Linux Performance</a></li>
<li><a href="http://www.slideshare.net/brendangregg/linux-performance-analysis-and-tools" target="_blank" rel="external">Linux performance analysis and tools</a></li>
<li><a href="http://www.vpsee.com/tag/performance/" target="_blank" rel="external">Tag: performance</a></li>
<li><a href="https://perf.wiki.kernel.org/index.php/Tutorial" target="_blank" rel="external">perf wiki</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/09/08/linux-performace-tools/" data-id="cin61d0ks008tfyizrnhfrj06" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/valgrind/">valgrind</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sync" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/09/07/sync/" class="article-date">
  <time datetime="2014-09-06T16:00:00.000Z" itemprop="datePublished">2014-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/07/sync/">sync</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h3><p>sync, linux command, using to write any data buffer in memory out to disk.</p>
<p>It do nothing, but exercise the ‘sync’ system call</p>
<p>So, if we want to study what the ‘sync’ really do, go in the kernel.</p>
<h3 id="sync-command"><a href="#sync-command" class="headerlink" title="sync command"></a>sync command</h3><p>File: coreutils-8.9/src/sync.c</p>
<pre><code>int
main (int argc, char **argv)
{
  initialize_main (&amp;argc, &amp;argv);
  set_program_name (argv[0]);
  setlocale (LC_ALL, &quot;&quot;);
  bindtextdomain (PACKAGE, LOCALEDIR);
  textdomain (PACKAGE);

  atexit (close_stdout);

  parse_long_options (argc, argv, PROGRAM_NAME, PACKAGE, Version,
                      usage, AUTHORS, (char const *) NULL);
  if (getopt_long (argc, argv, &quot;&quot;, NULL, NULL) != -1)
    usage (EXIT_FAILURE);

  if (optind &lt; argc)
    error (0, 0, _(&quot;ignoring all arguments&quot;));

  sync ();
  exit (EXIT_SUCCESS);
}
</code></pre><p>Do nothing, but do system call <code>sync()</code></p>
<h3 id="sync-architecture-in-kernel"><a href="#sync-architecture-in-kernel" class="headerlink" title="sync architecture in kernel"></a>sync architecture in kernel</h3><p>system call <code>sync()</code> is defined in fs/sync.c</p>
<pre><code>/*
 * sync everything.  Start out by waking pdflush, because that writes back
 * all queues in parallel.
 */
SYSCALL_DEFINE0(sync)
{
    wakeup_flusher_threads(0);
    sync_filesystems(0);
    sync_filesystems(1);
    if (unlikely(laptop_mode))
        laptop_sync_completion();
    return 0;
}
</code></pre><p><code>sync</code> call <code>sync_filesystems</code>  </p>
<pre><code>static void sync_filesystems(int wait)
{
    struct super_block *sb;
    static DEFINE_MUTEX(mutex);

    mutex_lock(&amp;mutex);        /* Could be down_interruptible */
    spin_lock(&amp;sb_lock);
    list_for_each_entry(sb, &amp;super_blocks, s_list)
        sb-&gt;s_need_sync = 1;

restart:
    list_for_each_entry(sb, &amp;super_blocks, s_list) {
        if (!sb-&gt;s_need_sync)
            continue;
        sb-&gt;s_need_sync = 0;
        sb-&gt;s_count++;
        spin_unlock(&amp;sb_lock);

        down_read(&amp;sb-&gt;s_umount);
        if (!(sb-&gt;s_flags &amp; MS_RDONLY) &amp;&amp; sb-&gt;s_root &amp;&amp; sb-&gt;s_bdi)
            __sync_filesystem(sb, wait);
        up_read(&amp;sb-&gt;s_umount);

        /* restart only when sb is no longer on the list */
        spin_lock(&amp;sb_lock);
        if (__put_super_and_need_restart(sb))
            goto restart;
    }
    spin_unlock(&amp;sb_lock);
    mutex_unlock(&amp;mutex);
}
</code></pre><p><code>sync_filesystems</code> call <code>__sync_filesystem</code> </p>
<pre><code>static int __sync_filesystem(struct super_block *sb, int wait)
{
    /*
     * This should be safe, as we require bdi backing to actually
     * write out data in the first place
     */
    if (!sb-&gt;s_bdi)
        return 0;

    /* Avoid doing twice syncing and cache pruning for quota sync */
    if (!wait) {
        writeout_quota_sb(sb, -1);
        writeback_inodes_sb(sb);
    } else {
        sync_quota_sb(sb, -1);
        sync_inodes_sb(sb);
    }
    if (sb-&gt;s_op-&gt;sync_fs)
        sb-&gt;s_op-&gt;sync_fs(sb, wait);
    return __sync_blockdev(sb-&gt;s_bdev, wait);
}
</code></pre><p><code>__sync_filesystem</code> call <code>sb-&gt;s_op-&gt;sync_fs(sb, wait)</code>, each filesystem should<br>implement the sync_fs()</p>
<h3 id="when-to-use"><a href="#when-to-use" class="headerlink" title="when to use"></a>when to use</h3><ol>
<li>before shutdown computer, using <code>sync</code> more than twice</li>
<li>after write big file to disk, such as using command <code>cp</code></li>
<li>to be continue</li>
</ol>
<h3 id="sync-fsync-fdatasync"><a href="#sync-fsync-fdatasync" class="headerlink" title="sync,fsync,fdatasync"></a>sync,fsync,fdatasync</h3><ul>
<li>sync, add the modified buffer to write_queue, then return immediately, not wait<br>for the reality disk writed.</li>
<li>fsync, used for single file with specify file description,and wait the disk write finish.</li>
<li>fdatasync, similar to fsync, but just do effect to the data part. fsync make<br>effect to data and file property.</li>
</ul>
<h3 id="special-application"><a href="#special-application" class="headerlink" title="special application"></a>special application</h3><ol>
<li>How if I want to sync from serval Virtual Disks, and ignore serval VDs</li>
<li>To be continue</li>
</ol>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li>man sync</li>
<li>info coreutils ‘sync invocation’ </li>
<li>kernel code</li>
<li><a href="ftp://ftp.gnu.org/gnu/coreutils/coreutils-8.9.tar.xz" target="_blank" rel="external">coreutils-8.9</a></li>
<li><a href="http://jesserei.blog.163.com/blog/static/121411689201032015129673/" target="_blank" rel="external">sync、fsync和fdatasync函数</a></li>
<li><a href="http://www.2cto.com/os/201204/126687.html" target="_blank" rel="external">缓存同步操作–sys_sync系统调用</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://matrix207.github.com/2014/09/07/sync/" data-id="cin61d0ko008qfyiz6zxq3olv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/6/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/debug/">debug</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/math/">math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/windows/">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ARP/" style="font-size: 10px;">ARP</a> <a href="/tags/Auto-Compile/" style="font-size: 10px;">Auto Compile</a> <a href="/tags/Batch-File/" style="font-size: 10px;">Batch File</a> <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/Emacs/" style="font-size: 10px;">Emacs</a> <a href="/tags/FAQ/" style="font-size: 10px;">FAQ</a> <a href="/tags/ICMP/" style="font-size: 10px;">ICMP</a> <a href="/tags/IRC/" style="font-size: 10px;">IRC</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/NetworkStack/" style="font-size: 12.5px;">NetworkStack</a> <a href="/tags/Notepad/" style="font-size: 10px;">Notepad++</a> <a href="/tags/Translation/" style="font-size: 17.5px;">Translation</a> <a href="/tags/WinIO/" style="font-size: 10px;">WinIO</a> <a href="/tags/api/" style="font-size: 10px;">api</a> <a href="/tags/arp/" style="font-size: 10px;">arp</a> <a href="/tags/auto-compile/" style="font-size: 10px;">auto compile</a> <a href="/tags/awk/" style="font-size: 12.5px;">awk</a> <a href="/tags/batch/" style="font-size: 20px;">batch</a> <a href="/tags/blat/" style="font-size: 12.5px;">blat</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/dot/" style="font-size: 10px;">dot</a> <a href="/tags/exploit/" style="font-size: 10px;">exploit</a> <a href="/tags/flowchart/" style="font-size: 10px;">flowchart</a> <a href="/tags/gedit/" style="font-size: 10px;">gedit</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/github/" style="font-size: 12.5px;">github</a> <a href="/tags/google/" style="font-size: 10px;">google</a> <a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a> <a href="/tags/hardware-monitor/" style="font-size: 10px;">hardware monitor</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/javascript/" style="font-size: 10px;">javascript</a> <a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/kvm/" style="font-size: 12.5px;">kvm</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/lisp/" style="font-size: 10px;">lisp</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/mail/" style="font-size: 10px;">mail</a> <a href="/tags/malloc-abc/" style="font-size: 10px;">malloc abc</a> <a href="/tags/mathematician/" style="font-size: 10px;">mathematician</a> <a href="/tags/maxima/" style="font-size: 10px;">maxima</a> <a href="/tags/mtrace/" style="font-size: 10px;">mtrace</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/net-snmp/" style="font-size: 10px;">net-snmp</a> <a href="/tags/netbios/" style="font-size: 10px;">netbios</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/novels/" style="font-size: 10px;">novels</a> <a href="/tags/opennebula/" style="font-size: 10px;">opennebula</a> <a href="/tags/org-mode/" style="font-size: 10px;">org mode</a> <a href="/tags/pandoc/" style="font-size: 10px;">pandoc</a> <a href="/tags/plugin/" style="font-size: 10px;">plugin</a> <a href="/tags/raid/" style="font-size: 10px;">raid</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/sed/" style="font-size: 12.5px;">sed</a> <a href="/tags/shell/" style="font-size: 17.5px;">shell</a> <a href="/tags/skype/" style="font-size: 12.5px;">skype</a> <a href="/tags/source-analyze/" style="font-size: 10px;">source analyze</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/study/" style="font-size: 10px;">study</a> <a href="/tags/svn/" style="font-size: 17.5px;">svn</a> <a href="/tags/tunnel/" style="font-size: 10px;">tunnel</a> <a href="/tags/valgrind/" style="font-size: 12.5px;">valgrind</a> <a href="/tags/vi/" style="font-size: 10px;">vi</a> <a href="/tags/vim/" style="font-size: 17.5px;">vim</a> <a href="/tags/wget/" style="font-size: 10px;">wget</a> <a href="/tags/wifi/" style="font-size: 10px;">wifi</a> <a href="/tags/wireless-tools/" style="font-size: 10px;">wireless-tools</a> <a href="/tags/wpa-supplicant/" style="font-size: 10px;">wpa_supplicant</a> <a href="/tags/xml/" style="font-size: 10px;">xml</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">September 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/04/18/hexo/">Hexo</a>
          </li>
        
          <li>
            <a href="/2016/04/13/malloc/">malloc</a>
          </li>
        
          <li>
            <a href="/2016/03/12/performance-optimization-of-cplusplus/">performance optimization of C++</a>
          </li>
        
          <li>
            <a href="/2016/03/09/stack-trace-when-program-crash/">stack trace when program crash</a>
          </li>
        
          <li>
            <a href="/2016/03/09/database-knowledges/">Database knowledges</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Matrix207<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>