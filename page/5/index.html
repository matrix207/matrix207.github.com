<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2015-01-21-linux-network-performance-monitor" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2015-01-21-linux-network-performance-monitor/" class="article-date">
  <time datetime="2016-04-17T10:13:48.611Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2015-01-21-linux-network-performance-monitor/">linux network performance monitor</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>###ethtool</p>
<p>###iptraf </p>
<p>###netperf</p>
<p>###iperf<br>Build from source:  </p>
<pre><code>[root@localhost ~]# tar xvf iperf-2.0.5.tar.gz 
...
[root@localhost ~]# cd iperf-2.0.5
[root@localhost iperf-2.0.5]# ./configure 
...
[root@localhost iperf-2.0.5]# make
...
</code></pre><p>On server machine:  </p>
<pre><code>[root@Ustor iperf-2.0.5]# ./src/iperf -s
------------------------------------------------------------
Server listening on TCP port 5001
TCP window size: 85.3 KByte (default)
------------------------------------------------------------
[  4] local 192.16.110.80 port 5001 connected with 192.16.110.50 port 43341
[ ID] Interval       Transfer     Bandwidth
[  4]  0.0-10.0 sec  9.20 GBytes  7.90 Gbits/sec
[  5] local 192.16.110.80 port 5001 connected with 192.16.110.50 port 43342
[  5]  0.0-10.0 sec  9.26 GBytes  7.95 Gbits/sec
[  4] local 192.16.110.80 port 5001 connected with 192.16.110.50 port 43343
[  4]  0.0-10.0 sec  8.98 GBytes  7.71 Gbits/sec
</code></pre><p>On Client machine:  </p>
<pre><code>[root@localhost iperf-2.0.5]# ./src/iperf -c 192.16.110.80 -f M -i 2
------------------------------------------------------------
Client connecting to 192.16.110.80, TCP port 5001
TCP window size: 0.02 MByte (default)
------------------------------------------------------------
[  3] local 192.16.110.50 port 43343 connected with 192.16.110.80 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0- 2.0 sec  1598 MBytes   799 MBytes/sec
[  3]  2.0- 4.0 sec  1919 MBytes   960 MBytes/sec
[  3]  4.0- 6.0 sec  1892 MBytes   946 MBytes/sec
[  3]  6.0- 8.0 sec  1894 MBytes   947 MBytes/sec
[  3]  8.0-10.0 sec  1893 MBytes   947 MBytes/sec
[  3]  0.0-10.0 sec  9196 MBytes   920 MBytes/sec
</code></pre><ul>
<li>通用参数<ul>
<li>-f [k|m|K|M] 分别表示以Kbits, Mbits, KBytes, MBytes显示报告，默认以Mbits为单位,eg:iperf -c 222.35.11.23 -f K</li>
<li>-i sec 以秒为单位显示报告间隔，eg:iperf -c 222.35.11.23 -i 2</li>
<li>-l 缓冲区大小，默认是8KB,eg:iperf -c 222.35.11.23 -l 16</li>
<li>-m 显示tcp最大mtu值</li>
<li>-o 将报告和错误信息输出到文件eg:iperf -c 222.35.11.23 -o c:\iperflog.txt</li>
<li>-p 指定服务器端使用的端口或客户端所连接的端口eg:iperf -s -p 9999;iperf -c 222.35.11.23 -p 9999</li>
<li>-u 使用udp协议,测试htb的时候最好用udp，udp通信开销小，测试的带宽更准确</li>
<li>-w 指定TCP窗口大小，默认是8KB.如果窗口太小，有可能丢包</li>
<li>-B 绑定一个主机地址或接口（当主机有多个地址或接口时使用该参数）</li>
<li>-C 兼容旧版本（当server端和client端版本不一样时使用）</li>
<li>-M 设定TCP数据包的最大mtu值</li>
<li>-N 设定TCP不延时</li>
<li>-V 传输ipv6数据包</li>
</ul>
</li>
<li>server专用参数<ul>
<li>-D 以服务方式运行ipserf，eg:iperf -s -D</li>
<li>-R 停止iperf服务，针对-D，eg:iperf -s -R</li>
</ul>
</li>
<li>client端专用参数<ul>
<li>-d 同时进行双向传输测试</li>
<li>-n 指定传输的字节数，eg:iperf -c 222.35.11.23 -n 100000</li>
<li>-r 单独进行双向传输测试</li>
<li>-b 指定发送带宽，默认是1Mbit/s. 在测试qos的时候，这是最有用的参数。</li>
<li>-t 测试时间，默认10秒,eg:iperf -c 222.35.11.23 -t 5.默认是10s</li>
<li>-F 指定需要传输的文件</li>
<li>-T 指定ttl值 </li>
</ul>
</li>
</ul>
<p>###tcpdump tcptrace</p>
<ul>
<li>tcpdump -i eth0</li>
<li>tcpdump -i eth0 host 172.16.30.44 and port 80</li>
<li>tcpdump -U port 3260 -w /tmp/tcpdump.pcap</li>
</ul>
<p>###Reference</p>
<ul>
<li><a href="http://www.vpsee.com/2009/11/linux-system-performance-monitoring-network/" target="_blank" rel="external">Linux性能监测：network</a></li>
<li><a href="http://blog.chinaunix.net/uid-20778443-id-94533.html" target="_blank" rel="external">iperf 使用总结</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2015-01-21-linux-network-performance-monitor/" data-id="cin4f0h4z006vl8iztklu8d2m" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2014-12-26-network-analyze-with-wireshark" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-12-26-network-analyze-with-wireshark/" class="article-date">
  <time datetime="2016-04-17T10:13:48.610Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-12-26-network-analyze-with-wireshark/">network analyze with wireshark</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>####Filter<br>1.过滤IP，如来源IP或者目标IP等于某个IP</p>
<pre><code>例子:
ip.src eq 192.168.1.107 or ip.dst eq 192.168.1.107
或者
ip.addr eq 192.168.1.107 // 都能显示来源IP和目标IP
</code></pre><p>2.过滤端口</p>
<pre><code>例子:
tcp.port eq 80 // 不管端口是来源的还是目标的都显示
tcp.port == 80
tcp.port eq 2722
tcp.port eq 80 or udp.port eq 80
tcp.dstport == 80 // 只显tcp协议的目标端口80
tcp.srcport == 80 // 只显tcp协议的来源端口80
udp.port eq 15000
过滤端口范围
tcp.port &gt;= 1 and tcp.port &lt;= 80
</code></pre><p>3.过滤协议</p>
<pre><code>例子:
tcp
udp
arp
icmp
http
smtp
ftp
dns
msnms
ip
ssl
oicq
bootp
等等
排除arp包，如!arp  或者  not arp
</code></pre><p>4.过滤MAC</p>
<pre><code>太以网头过滤
eth.dst == A0:00:00:04:C5:84 // 过滤目标mac
eth.src eq A0:00:00:04:C5:84 // 过滤来源mac
eth.dst==A0:00:00:04:C5:84
eth.dst==A0-00-00-04-C5-84
eth.addr eq A0:00:00:04:C5:84 // 过滤来源MAC和目标MAC都等于A0:00:00:04:C5:84的
less than 小于 &lt; lt
小于等于 le
等于 eq
大于 gt
大于等于 ge
不等 ne
</code></pre><p>5.包长度过滤</p>
<pre><code>例子:
udp.length == 26 这个长度是指udp本身固定长度8加上udp下面那块数据包之和
tcp.len &gt;= 7  指的是ip数据包(tcp下面那块数据),不包括tcp本身
ip.len == 94 除了以太网头固定长度14,其它都算是ip.len,即从ip本身到最后
frame.len == 119 整个数据包长度,从eth开始到最后
eth —&gt; ip or arp —&gt; tcp or udp —&gt; data
</code></pre><p>6.http模式过滤</p>
<pre><code>例子:
http.request.method == GET
http.request.method == POST
http.request.uri == /img/logo-edu.gif
http contains GET
http contains HTTP/1.
// GET包
http.request.method == GET &amp;&amp; http contains Host:
http.request.method == GET &amp;&amp; http contains User-Agent:
// POST包
http.request.method == POST &amp;&amp; http contains Host:
http.request.method == POST &amp;&amp; http contains User-Agent:
// 响应包
http contains HTTP/1.1 200 OK &amp;&amp; http contains Content-Type:
http contains HTTP/1.0 200 OK &amp;&amp; http contains Content-Type:
一定包含如下
Content-Type:
</code></pre><p>7.TCP参数过滤</p>
<pre><code>tcp.flags 显示包含TCP标志的封包。
tcp.flags.syn == 0×02    显示包含TCP SYN标志的封包。
tcp.window_size == 0 &amp;&amp; tcp.flags.reset != 1
</code></pre><p>8.过滤内容</p>
<pre><code>tcp[20]表示从20开始，取1个字符
tcp[20:]表示从20开始，取1个字符以上
tcp[20:8]表示从20开始，取8个字符
tcp[offset,n]
udp[8:3]==81:60:03 // 偏移8个bytes,再取3个数，是否与==后面的数据相等？
udp[8:1]==32  如果我猜的没有错的话，应该是udp[offset:截取个数]=nValue
eth.addr[0:3]==00:06:5B

例子:
判断upd下面那块数据包前三个是否等于0×20 0×21 0×22
我们都知道udp固定长度为8
udp[8:3]==20:21:22
判断tcp那块数据包前三个是否等于0×20 0×21 0×22
tcp一般情况下，长度为20,但也有不是20的时候
tcp[8:3]==20:21:22
如果想得到最准确的，应该先知道tcp长度
matches(匹配)和contains(包含某字符串)语法
ip.src==192.168.1.107 and udp[8:5] matches x02x12x21x00x22
ip.src==192.168.1.107 and udp contains 02:12:21:00:22
ip.src==192.168.1.107 and tcp contains GET
udp contains 7c:7c:7d:7d 匹配payload中含有0x7c7c7d7d的UDP数据包，不一定是从第一字节匹配。

例子:
得到本地qq登陆数据包(判断条件是第一个包==0×02,第四和第五个包等于0x00x22,最后一个包等于0×03)
0×02 xx xx 0×00 0×22 … 0×03
正确
oicq and udp[8:] matches ^x02[x00-xff][x00-xff]x00x22[x00-xff]+x03$
oicq and udp[8:] matches ^x02[x00-xff]{2}x00x22[x00-xff]+x03$ // 登陆包
oicq and (udp[8:] matches ^x02[x00-xff]{2}x03$ or tcp[8:] matches ^x02[x00-xff]{2}x03$)
oicq and (udp[8:] matches ^x02[x00-xff]{2}x00x22[x00-xff]+x03$ or tcp[20:] matches ^x02[x00-xff]{2}x00x22[x00-xff]+x03$)
不单单是00:22才有QQ号码,其它的包也有,要满足下面条件(tcp也有，但没有做):
oicq and udp[8:] matches ^x02[x00-xff]+x03$ and !(udp[11:2]==00:00) and !(udp[11:2]==00:80)
oicq and udp[8:] matches ^x02[x00-xff]+x03$ and !(udp[11:2]==00:00) and !(udp[15:4]==00:00:00:00)
说明:
udp[15:4]==00:00:00:00 表示QQ号码为空
udp[11:2]==00:00 表示命令编号为00:00
udp[11:2]==00:80 表示命令编号为00:80
当命令编号为00:80时，QQ号码为00:00:00:00
得到msn登陆成功账号(判断条件是USR 7 OK ,即前三个等于USR，再通过两个0×20，就到OK,OK后面是一个字符0×20,后面就是mail了)
USR xx OK mail@hotmail.com
正确
msnms and tcp and ip.addr==192.168.1.107 and tcp[20:] matches ^USRx20[x30-x39]+x20OKx20[x00-xff]+
</code></pre><p>9.dns模式过滤</p>
<p>10.DHCP</p>
<pre><code>以寻找伪造DHCP服务器为例，介绍Wireshark的用法。在显示过滤器中加入过滤规则，
显示所有非来自DHCP服务器并且bootp.type==0×02（Offer/Ack）的信息：
bootp.type==0×02 and not ip.src==192.168.1.1
</code></pre><p>11.msn</p>
<pre><code>msnms &amp;&amp; tcp[23:1] == 20 // 第四个是0×20的msn数据包
msnms &amp;&amp; tcp[20:1] &gt;= 41 &amp;&amp; tcp[20:1] &lt;= 5A &amp;&amp; tcp[21:1] &gt;= 41 &amp;&amp; tcp[21:1] &lt;= 5A &amp;&amp; tcp[22:1] &gt;= 41 &amp;&amp; tcp[22:1] &lt;= 5A
msnms &amp;&amp; tcp[20:3]==USR // 找到命令编码是USR的数据包
msnms &amp;&amp; tcp[20:3]==MSG // 找到命令编码是MSG的数据包
tcp.port == 1863 || tcp.port == 80
如何判断数据包是含有命令编码的MSN数据包?
1)端口为1863或者80,如:tcp.port == 1863 || tcp.port == 80
2)数据这段前三个是大写字母,如:
  tcp[20:1] &gt;= 41 &amp;&amp; tcp[20:1] &lt;= 5A &amp;&amp; tcp[21:1] &gt;= 41 &amp;&amp; tcp[21:1] &lt;= 5A &amp;&amp; tcp[22:1] &gt;= 41 &amp;&amp; tcp[22:1] &lt;= 5A
3)第四个为0×20,如:tcp[23:1] == 20
4)msn是属于TCP协议的,如tcp
</code></pre><p>####case 1</p>
<ul>
<li>1， “业务突然变慢，客户端（确定）和服务端（应该）都没有改动。”  </li>
</ul>
<p>[沛满]：如果怀疑是网络有问题，可以在业务慢的时候抓个500MB左右的网络包分析一下。<br>论坛可以上传的话我也可以帮忙分析。</p>
<ul>
<li>2，“在wireshark上，如何方便查一个tcp报对应的响应包（或响应包对应的原始包）。可<br>以手工根据sequence id和ack id来判断，但是wireshark提供方便的工具么？—-我们的业<br>务是在一个tcp长连接中发很多包。”</li>
</ul>
<p>[沛满]：这个要从基本原理讲起。TCP的工作方式不是逐个包发送的，而是一口气发出多个包<br>，从而提高传输效率。就像快递员会一次性携带很多包裹到我司前台一样，为的是减少消耗<br>在路上的往返时间。接收方收到这些包之后有两个选择，既可以每个包都确认（也就是你提<br>到的响应），也可以只确认最后一个来暗示所有包都收到了。举个例子，发送方发出了10个<br>包，编号1至10，且没有一个丢失的，那接收方既可以回复10个确认包，也可以只回复“ack 11”，<br>表示10以及10之前的所有包都收到了。当有丢包发生时，比如还是发送了10个包的情况，编号<br>也是1至10，但其中10号包丢失了，那接收方可以回复9个确认包，也可以只回复“ack 10”，<br>表示9以及9之前的包都收到了。</p>
<p>了解了这个原理，我们就知道在Wireshark上没有必要去对应每个ack和seq，因为大多数包即<br>便正常收到后也不会有ack。</p>
<ul>
<li>3，“有没有技巧可以方便的统计延时的情况，例如某时间段中，发包到收到ack的延时超过1s的数据包数量？”</li>
</ul>
<p>[沛满]：如果你只是想了解网络延时状况，那用ping最简单准确了，没有必要用Wireshark。<br>一般我们在乎的是应用层的延时，比如向一个服务器发送读请求，到收到读响应的时间差究竟<br>有多少。Wireshark上有提供这个功能，比如CIFS协议那就可以用“smb.time &gt; 1”来过滤出所<br>有超过一秒钟的延时的CIFS操作。如果是NFS，就用rpc.time（因为NFS是基于RPC的协议）。<br>HTTP也有http.time。</p>
<ul>
<li>4，“有没有技巧可以方便的统计丢包的情况，例如某时间段中，发出去的包没收到ack的有多少？”</li>
</ul>
<p>[沛满]：还是那句话，没有收到ack不一定是丢包了。如果是想看丢包重传的统计，那就<br>Analyze–&gt;Expert Info，然后看warnings or notes tab. 虽然要统计出结果很容易，不过<br>使用者需要理解tcp的基础知识才能解读这个结果，比如一个超时重传，导致的后果远远超过<br>一个快速重传。有启用SACK的时候，处理多个丢包的效率远高于没有启用SACK的……这个说起来太复杂了</p>
<p>####Reference</p>
<ul>
<li><a href="https://community.emc.com/thread/194901" target="_blank" rel="external">一站式学习Wireshark</a></li>
<li><a href="http://ninecmd.com/archives/97?replytocom=5" target="_blank" rel="external">WireShark 过滤语法</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-12-26-network-analyze-with-wireshark/" data-id="cin4f0h4y006tl8iz4iwy17oj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2014-12-12-how-to-implement-a-netdisk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-12-12-how-to-implement-a-netdisk/" class="article-date">
  <time datetime="2016-04-17T10:13:48.609Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-12-12-how-to-implement-a-netdisk/">how to implement a netdisk</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>###Introduce</p>
<p>###Function list</p>
<ol>
<li>File upload</li>
<li>File download</li>
<li>File list</li>
<li>File share</li>
<li>File classification</li>
<li>offline download</li>
</ol>
<p>###Architecture</p>
<p>###Component implement</p>
<p>###Features</p>
<ol>
<li>File Reduplication</li>
</ol>
<p>###TODO</p>
<p>###Reference</p>
<ul>
<li><a href="http://open.qiniudn.com/my-road-of-cloud-storage.pdf" target="_blank" rel="external">我的存储之路</a></li>
<li><a href="http://www.zhihu.com/question/21591490" target="_blank" rel="external">网盘(云盘)的大空间是如何实现的?</a></li>
<li><a href="http://www.zte.com.cn/cn/products/cocloud/application/201208/t20120810_341895.html" target="_blank" rel="external">云盘 ZXCLOUD iSpace</a></li>
<li><a href="http://u.wems.net/index.html" target="_blank" rel="external">USpace</a></li>
<li><a href="http://wenku.baidu.com/link?url=TN-CFldzfea0lwlY-j6cnpgfzuJlA31AV2td16qFni_0BvIea-_izUSroc5sd-4xxRv2HriEQbcYsa8xb8XiHDxzlr4kMZPwkdaYe_vt63m" target="_blank" rel="external">USpace产品介绍</a></li>
<li><a href="http://501565246-qq-com.iteye.com/blog/1738716" target="_blank" rel="external">云存储之网盘浅析</a></li>
<li><a href="http://developer.baidu.com/wiki/index.php?title=docs/cplat/bcs/sdk" target="_blank" rel="external">百度云存储SDK及工具</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-12-12-how-to-implement-a-netdisk/" data-id="cin4f0h4x006sl8iz5uktsovs" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2014-12-08-how-to-fix-nic-name-confusion" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-12-08-how-to-fix-nic-name-confusion/" class="article-date">
  <time datetime="2016-04-17T10:13:48.608Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-12-08-how-to-fix-nic-name-confusion/">how to fix NIC name confusion</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>####Description</p>
<p>list some text from command <code>dmesg</code>:  </p>
<pre><code>792 igb 0000:02:00.0: Intel(R) Gigabit Ethernet Network Connection
793 igb 0000:02:00.0: eth0: (PCIe:2.5GT/s:Width x1)
794 igb 0000:02:00.0: eth0: MAC: 00:1e:67:58:cc:b8
795 igb 0000:02:00.0: eth0: PBA No: 009000-000
796 igb 0000:02:00.0: LRO is disabled
797 igb 0000:02:00.0: Using MSI-X interrupts. 1 rx queue(s), 1 tx queue(s)
798 igb 0000:03:00.0: PCI INT A -&gt; GSI 18 (level, low) -&gt; IRQ 18
799 igb 0000:03:00.0: setting latency timer to 64
800   alloc irq_desc for 32 on node -1
801   alloc kstat_irqs on node -1
802 igb 0000:03:00.0: irq 32 for MSI/MSI-X
803   alloc irq_desc for 33 on node -1
804   alloc kstat_irqs on node -1
805 igb 0000:03:00.0: irq 33 for MSI/MSI-X
806 igb 0000:03:00.0: Intel(R) Gigabit Ethernet Network Connection
807 igb 0000:03:00.0: eth1: (PCIe:2.5GT/s:Width x1)
808 igb 0000:03:00.0: eth1: MAC: 00:1e:67:58:cc:b9
809 igb 0000:03:00.0: eth1: PBA No: 009000-000
810 igb 0000:03:00.0: LRO is disabled
811 igb 0000:03:00.0: Using MSI-X interrupts. 1 rx queue(s), 1 tx queue(s)
812 udev: renamed network interface eth0 to eth2
813 udev: renamed network interface eth1 to eth3
</code></pre><p>we can see that, interface name is eth0 and eth1 at the begin, then udev rename them.  </p>
<p>why?</p>
<p>####Checking and fix</p>
<p>check the rule of udev:</p>
<pre><code>[root@Ustor network]# cat /etc/udev/rules.d/70-persistent-net.rules
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR{address}==&quot;00:25:90:d7:be:b4&quot;, ATTR{type}==&quot;1&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth0&quot;
SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR{address}==&quot;00:25:90:d7:be:b5&quot;, ATTR{type}==&quot;1&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth1&quot;
</code></pre><p>check ip information:  </p>
<pre><code>[root@Ustor network]# ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
    link/ether 00:1e:67:58:cc:b8 brd ff:ff:ff:ff:ff:ff
    inet 172.16.60.220/24 brd 172.16.60.255 scope global eth2
    inet6 fe80::21e:67ff:fe58:ccb8/64 scope link 
       valid_lft forever preferred_lft forever
3: eth3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
    link/ether 00:1e:67:58:cc:b9 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::21e:67ff:fe58:ccb9/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><p>we found that, the mac address from udev rules and <code>ip addr</code> were difference.  </p>
<p>Because udev had defined which NIC used eth0 and eth1, the new NIC(new mac address)<br>should used new interface name(here, using eth2 and eth3).</p>
<p>BTW, I ask the workmate what he had done before this problem occur, he said this<br>os was installed on another board before. That was the problem, the NIC changed,<br>but os not update, so it maded the interface name changed.</p>
<p>Fixed:  </p>
<ol>
<li>update mac address to /etc/udev/rules.d/70-persistent-net.rules.mb2  </li>
<li>reboot  </li>
</ol>
<p>####Reference</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-12-08-how-to-fix-nic-name-confusion/" data-id="cin4f0h4w006rl8izn0ubtkyx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2014-12-04-ssd-cache-and-implementation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-12-04-ssd-cache-and-implementation/" class="article-date">
  <time datetime="2016-04-17T10:13:48.605Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-12-04-ssd-cache-and-implementation/">ssd cache and implementation</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>####Introduce</p>
<ul>
<li><p>SSD缓存技术</p>
<ul>
<li>SSD的特性是读速高于写，因此在无盘领域应用SSD时多用作读缓存来使用，SSD缓存源自<br>PXD无盘的SSD二级缓存技术。这里的二级缓存不是指CPU的二级CACHE，而是指应用于无<br>盘架构的第二级读缓存功能。 </li>
<li><a href="http://baike.baidu.com/view/3967982.htm" target="_blank" rel="external">http://baike.baidu.com/view/3967982.htm</a></li>
<li><a href="http://www.searchstorage.com.cn/showcontent_66616.htm" target="_blank" rel="external">http://www.searchstorage.com.cn/showcontent_66616.htm</a></li>
</ul>
</li>
<li><p>快速块设备为较慢的块设备提供缓存</p>
<ul>
<li>Red Hat Enterprise Linux 7.0 中引进让快速块设备作为较慢块设备的缓存的功能作为<br>技术预览。这个功能可让 PCIe SSD 设备作为直接附加存储（DAS）或者存储局域网（SAN）<br>存储的缓存使用，以便提高文件系统性能</li>
<li><a href="https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/7.0_Release_Notes/chap-storage.html" target="_blank" rel="external">Reference</a></li>
</ul>
</li>
</ul>
<p>####Facebook flashcache<br>Flashcache是Facebook技术团队的一个开源项目，最初是为加速MySQL设计。Flashcache通过<br>在文件系统（VFS）和设备驱动之间新增了一次缓存层，来实现对热门数据的缓存。</p>
<p>Flashcache在内核的层次：<br>VFS -&gt; Block层 -&gt; DM层 -&gt; flashcache -&gt; DeviceDriver -&gt; Disk</p>
<p>Flashcache最初的实现是write backup机制cache，后来又加入了write through和write around机制</p>
<pre><code>write backup: 先写入到cahce，然后cache中的脏块会由后台定期刷到持久存储。
write through: 同步写入到cache和持久存储。
write around: 只写入到持久存储。
</code></pre><p>参考:   </p>
<ul>
<li><a href="http://blog.chinaunix.net/uid-26950862-id-3948198.html" target="_blank" rel="external">Flashcache初探</a>  </li>
<li><a href="http://oldblog.donghao.org/2012/12/flashcacheoaiaoippt.html" target="_blank" rel="external">flashcache原理及改造（PPT）</a>  </li>
<li><a href="http://wenku.baidu.com/view/4c37447131b765ce0508142b?refer=&amp;clickSort=download" target="_blank" rel="external">flashcache原理及改造</a>  </li>
</ul>
<p>####What skills need to master</p>
<p>####Implementation</p>
<p>####Reference</p>
<ul>
<li><a href="http://blog.csdn.net/column/details/flashcache.html" target="_blank" rel="external">linux内核源码阅读之facebook硬盘加速利器flashcache</a></li>
<li><a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&amp;tid=1917560&amp;page=1#pid13842158" target="_blank" rel="external">发几个自己做的关于内核IO方面的ppt</a></li>
<li><a href="https://github.com/facebook/flashcache/" target="_blank" rel="external">flashcache</a>  </li>
<li><a href="http://www.haiyun.me/archives/centos-flashcache.html" target="_blank" rel="external">Centos安装Flashcache使用SSD缓存</a>  </li>
<li><a href="http://blog.csdn.net/kidd_3/article/details/6984822" target="_blank" rel="external">flashcache的实现与分析</a>  </li>
<li><a href="https://awk.so/patents/CN103744624A?cl=zh" target="_blank" rel="external">一种实现存储系统ssd缓存数据选择性升级的系统架构</a>  </li>
<li><a href="http://www.csdn.net/article/2013-10-31/2817357-facebook-flashcache-2010-2013" target="_blank" rel="external">命中率80%，磁盘I/O减半，Flashcache的发展史</a>  </li>
<li><a href="http://cdn.oreillystatic.com/en/assets/1/event/45/Flashcache%20Presentation.pdf" target="_blank" rel="external">FlashCache at Facebook</a>  </li>
<li><a href="http://blog.chinaunix.net/uid-26950862-id-3948198.html" target="_blank" rel="external">Flashcache初探</a>  </li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-12-04-ssd-cache-and-implementation/" data-id="cin4f0h4t006ql8izr5w8bzpb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2014-11-26-lio" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-11-26-lio/" class="article-date">
  <time datetime="2016-04-17T10:13:48.604Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-11-26-lio/">LIO</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>####历史</p>
<ul>
<li>Linux 2.6.38 为分界线，此前的标准是 Linux SCSI Target , STGT 之后迄今为止的<br>标准是 Linux-IO Target , LIO 确切的说 Linus Torvalds 在 2011年1月15日将<br>LIO SCSI Target engine merge 到 Linux 2.6.38 中</li>
<li>暂时使用LIO作为IET替代，因为IET当前已不更新，最新版2010年。而LIO已进入内核，<br>怎么说这几年应该都会持续发展,属于主流应用。</li>
</ul>
<p>####LIO代码量  </p>
<ul>
<li><code>/home/dennis/work/kernel/linux-3.2.63/drivers/target</code></li>
<li><code>[dennis@localhost target]$ find ./* -name &quot;*.*&quot; |xargs wc -l |awk &#39;END{print $1}&#39;</code><br>52187  </li>
<li><code>[dennis@localhost target]$ find iscsi/ -name &quot;*.*&quot; |xargs wc -l |awk &#39;END{print $1}&#39;</code><br>21801  </li>
</ul>
<p>####开源iSCSI Target调研</p>
<ul>
<li>SCST与LIO  <ul>
<li>SCST是一个相对较早且比较成熟的SCSI Target开源实现。  </li>
<li>LIO相比SCST是一个更晚的SCSI Target开源实现，但在与SCST竞争进入Linux内核中，<br>却以LIO胜出告终。关于二者之间进入Linux内核时的争论，LWN上一篇很 有趣的文章，<br>A tale of two SCSI Targets，中文翻译为“SCSI Target之 双城记”。  </li>
<li>虽然LIO因为进入Linux内核而有了更好的发展前景，但SCST也不差，Fusion-io 公司<br>刚刚收购了SCST的商业支持公司ID7。</li>
</ul>
</li>
<li>Tgt  <ul>
<li>Tgt也是一个通用的SCST Target开源实现，与前两者不同的是，在支持iSCSI协 议上，<br>Tgt的所有代码是完全工作在用户态的。  </li>
<li>Tgt将LU视为backstore，支持backstore可以模块化，也就是说，你可以写一个模块来<br>支持你自己定义的LU。Tgt提供了多线程api接口，使得编写backstore时 ，可以使用多<br>个线程同时处理SCSI请求。  </li>
<li>Tgt的主线程使用epoll LT模型，监听并接收Initiator发来<br>的读写请求与命令 ，而调用对应的backstore处理模块。</li>
</ul>
</li>
<li>iSCSI Target支持LU是分布式文件系统时的优化  <ul>
<li>iSCSI Target与LU之间支持多连接并发读写请求，对于不要求排序的SCSI命令与数据，可以并发发给LU  </li>
<li>iSCSI Target对SCSI命令与数据进行合并，然后发给LU。  </li>
</ul>
</li>
<li>比较  <ul>
<li>无论是SCST还是LIO，我都不认为它们是支持分布式文件系统的最佳选择。<br>首先，它们都是工作在内核态的，一旦出问题，会导致系统挂掉，直接影响跑在系统上的其他线上服务。<br>其次，SCSI与LIO作为通用的SCSI Target实现，在处理完iSCSI协议后，会把SCSI的<br>处理交给内核SCSI Driver去处理，这对支持分布式文件做二次开发来说，相对更加困难。</li>
<li>LIO对于一个LU，分配一个recv线程与一个send线程，recv线程接收Initiator发来的<br>iSCSI PDU，解析成SCSI请求后交给send线程，send线程将请求发给LU，并将LU返回<br>的结果返回给Initiator。对于LU是分布式文件系统时，一个send线程的框架让支持<br>iSCSI Target与LU之间多连接并发读写相对比较困难。而且LIO对iSCSI协议的支持，<br>很难针对LU是分布式文件系统做优化。LIO的send线程 与recv线程使用一个队列进行<br>通信，该队列中的SCSI请求，有些不关心顺序，有些却关心，这些都是在send线程遍<br>历队列时才进行处理的。如果要支持LU的多连接并发读写，需要额外的队列来维护SCSI<br>请求，这个队列对SCSI请求到达LU的顺序没有要求。当然，也要额外支持多线程等处理。</li>
<li>Tgt由于工作在用户态，没有缺点1，而且Tgt的backstore可以模块化，开发起来非常方便，<br>同时backstore支持多线程处理，而且Tgt交给backstore的多线程处理的 list已经对顺序不作要求了。</li>
<li>从以上分析来看，使用Tgt让分布式文件系统支持iSCSI更加有优势，而且更加方便。<br>目前，开源分布式存储项目sheepdog与hlfs都是基于Tgt开发模块来支持 iSCSI协议的。</li>
</ul>
</li>
<li>Tgt的缺点与改进<ul>
<li>Tgt的backstore在使用多线程时，多个线程竞争一个list，开销较大。可以让 每个线程维护<br>一个list，主线程通过CAS无锁队列的方式，将SCSI请求根据rr算 法加入到每个线程的list中。</li>
<li>Tgt的backstore与LU之间连接数与线程数，是1：1关系，且线程数为4，写死了的。<br>可以修改代码，将连接数改为可配置的。</li>
<li>Tgt使用一个主线程通过epoll接受所有Initiator的读写请求，当登陆的Initiator较多时，<br>这里可能成为瓶颈。通常来说，这不是问题，因为会iSCSI Target会部署多个的。</li>
</ul>
</li>
</ul>
<p>###targetcli</p>
<ul>
<li>root权限运行targetcli</li>
<li>浏览存储对象, ls查看目录树信息，cd到执行目录</li>
<li>创建文件存储对象<ul>
<li>cd /backstores/fileio</li>
<li>create disk0 /tmp/disk0.img 10MB</li>
<li>cd /backstores/ramdisk</li>
<li>create rd0 10MB</li>
</ul>
</li>
<li>创建iSCSI目标<ul>
<li>cd /iscsi </li>
<li>create [这里可以加入自定义的WWN:WorldWide Name]</li>
<li>cd iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e/tpg1/</li>
<li>luns/ create /backstores/fileio/disk0</li>
<li>luns/ create /backstores/ramdisk/rd0</li>
<li>portals/ create 0.0.0.0 </li>
<li>set attribute authentication=0 demo_mode_write_protect=0 generate_node_acls=1 cache_dynamic_acls=1</li>
<li>cd /</li>
<li>ls</li>
<li>saveconfig</li>
</ul>
</li>
<li>当使用targetcli操作完毕后，记得使用saveconfig来保存配置，要不然重启target服务后，<br>刚才的配置将丢失.  <code>targetcli saveconfig</code><br>Last 10 configs saved in /etc/target/backup.<br>Configuration saved to /etc/target/saveconfig.json</li>
<li>启动iscsi target服务<ul>
<li>[root@localhost ~]# service target start </li>
<li>[root@localhost ~]# service target status</li>
</ul>
</li>
<li>装载iSCSI Target <ul>
<li>[root@localhost ~]# iscsiadm -m discovery -t sendtargets -p 127.0.0.1<br>127.0.0.1:3260,1 iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e</li>
<li>[root@localhost ~]# iscsiadm –mode node \  <blockquote>
<p>–targetname iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e \<br>–portal 127.0.0.1 –login</p>
</blockquote>
</li>
<li>上面的命令还可以使用简写模式: iscsiadm -m node -T \<blockquote>
<p>iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e \<br>-p 127.0.0.1 -l</p>
</blockquote>
</li>
<li>[root@localhost dennis]# lsscsi<br>[2:0:0:0]    disk    ATA      ST3160815AS      A     /dev/sda<br>[6:0:0:0]    disk    LIO-ORG  disk0            4.0   /dev/sdb<br>[6:0:0:1]    disk    LIO-ORG  rd0              4.0   /dev/sdc  </li>
</ul>
</li>
<li>卸载并删除iSCSI目标<ul>
<li>iscsiadm –mode node –targetname iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e –portal 127.0.0.1 –logout</li>
<li>或简写: iscsiadm -m node -T iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e -p 127.0.0.1 -u</li>
<li>targetcli iscsi/ delete iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e </li>
</ul>
</li>
<li>Other operation<ul>
<li>iscsiadm –mode node -U all</li>
<li>iscsiadm –mode node -o delete</li>
<li>iscsiadm –mode node</li>
</ul>
</li>
</ul>
<p>###测试脚本</p>
<pre><code>mkdir -p /lio/
targetcli /backstores/fileio create disk0 /lio/disk0.img 1024MB
targetcli /iscsi create iqn.2007-10.lio.com:lio.test
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/luns/ create /backstores/fileio/disk0
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/portals/ create 0.0.0.0 
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1 set attribute authentication=1 demo_mode_write_protect=0 generate_node_acls=1 cache_dynamic_acls=1
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/acls/ create iqn.2007-10.lio.com:acl01
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/acls/iqn.2007-10.lio.com:acl01/ set auth userid=dennis
targetcli /iscsi/iqn.2007-10.lio.com:lio.test/tpg1/acls/iqn.2007-10.lio.com:acl01/ set auth password=Dennis@123456
targetcli saveconfig
</code></pre><p>###其他操作</p>
<ul>
<li><p>增加本地监听ip地址和端口</p>
<p>  /iscsi/iqn.20…/tpg1/portals&gt; create 172.16.110.11 8089<br>  Created network portal 172.16.110.11:8089.<br>  /iscsi/iqn.20…/tpg1/portals&gt; ls<br>  o- portals …………………………………………… [Portals: 2]</p>
<pre><code>o- 0.0.0.0:3260 .................................................... [OK]
o- 172.16.110.11:8089 .............................................. [OK]
</code></pre><p>  /iscsi/iqn.20…/tpg1/portals&gt; status<br>  Status for /iscsi/iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.6b448471ba5e/tpg1/portals: Portals: 2</p>
</li>
<li><p>Initiator访问IP限制? 目前找不到方法！原来的IET有限制指定IP访问的功能，但是并不表示<br>该功能是iscsi协议必须实现的，所以现在的LIO没有这样的功能也是合理的。</p>
</li>
<li><p>如何设置块设备的IO模式为write-back或write-through? 目前找不到方法。对于FILEIO是可以的.</p>
<p>  [root@localhost src]# targetcli /backstores/fileio/ create fileio01.dat /tmp/fileio01.dat 10M write_back=False<br>  Created fileio fileio01.dat with size 10485760<br>  [root@localhost src]# ls /tmp/fileio01.dat -lh<br>  -rw-r–r–. 1 root root 10M Feb  3 15:01 /tmp/fileio01.dat<br>  [root@localhost src]# targetcli /backstores/fileio/ ls<br>  o- fileio ……………………………………………… [Storage Objects: 1]<br>  o- fileio01.dat ………….. [/tmp/fileio01.dat (10.0MiB) write-thru deactivated]<br>  [root@localhost src]# targetcli /backstores/fileio/ create fileio02.dat /tmp/fileio02.dat 10M write_back=True<br>  Created fileio fileio02.dat with size 10485760<br>  [root@localhost src]# targetcli /backstores/fileio/ ls<br>  o- fileio ……………………………………………… [Storage Objects: 2]<br>  o- fileio01.dat ………….. [/tmp/fileio01.dat (10.0MiB) write-thru deactivated]<br>  o- fileio02.dat ………….. [/tmp/fileio02.dat (10.0MiB) write-back deactivated]  </p>
</li>
<li><p>targetcli 设置CHAP登陆: acls中创建wwn, 设置用户名和密码</p>
<ul>
<li>/&gt; cd /iscsi/iqn.2007-10.lio.com:dg2.lv1/tpg1/</li>
<li>set attribute authentication=1</li>
<li>acls/ create iqn.1991-05.com.microsoft:ibm-t410s </li>
<li>cd acls/iqn.1991-05.com.microsoft:ibm-t410s</li>
<li>set auth userid=iqn.1991-05.com.microsoft:ibm-t410s</li>
<li>set auth password=mytargetsecret</li>
<li>saveconfig</li>
<li><p>reference <a href="http://linux-iscsi.org/wiki/ISCSI" target="_blank" rel="external">http://linux-iscsi.org/wiki/ISCSI</a></p>
<p>[root@localhost dennis]# iscsiadm -m node -p 172.16.130.200 -l<br>Logging in to [iface: default, target: iqn.2007-10.lio.com:dg2.lv1, portal: 172.16.130.200,3260] (multiple)<br>iscsiadm: Could not login to [iface: default, target: iqn.2007-10.lio.com:dg2.lv1, portal: 172.16.130.200,3260].<br>iscsiadm: initiator reported error (24 - iSCSI login failed due to authorization failure)<br>iscsiadm: Could not log into all portals</p>
</li>
</ul>
</li>
</ul>
<p>###配置检查</p>
<ul>
<li><p>/sys/kernel/config/target/iscsi/ </p>
<p>  [root@localhost ~]# ls -l /sys/kernel/config/target/iscsi<br>  total 0<br>  drwxr-xr-x. 2 root root    0 Dec 15 15:59 discovery_auth<br>  drwxr-xr-x. 4 root root    0 Dec 15 15:58 iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.f264093a034e<br>  drwxr-xr-x. 4 root root    0 Dec 15 15:59 iqn.2014-12.org.linux-iscsi.localhost.x8664:sn.f3849a0b356e<br>  -r–r–r–. 1 root root 4096 Dec 15 16:05 lio_version</p>
</li>
<li><p>当使用targetcli操作完毕后，记得使用saveconfig来保存配置，要不然重启target服务后，<br>刚才的配置将丢失.</p>
<p>  [root@localhost ~]# targetcli saveconfig<br>  Last 10 configs saved in /etc/target/backup.<br>  Configuration saved to /etc/target/saveconfig.json</p>
</li>
<li><p>关于配置文件 /etc/target/saveconfig.json的解析</p>
<ul>
<li>JSON (JavaScript Object Notation) is a lightweight data-interchange format</li>
<li>JSON 一种轻量级的数据交换格式</li>
<li><a href="http://www.json.org/" target="_blank" rel="external">http://www.json.org/</a></li>
</ul>
</li>
</ul>
<p>####需要验证测试的特性</p>
<ul>
<li>各中类型的性能比较<ul>
<li>FILEIO 性能</li>
<li>Block 性能</li>
</ul>
</li>
<li>增加或删除不用的lun是否需要重启服务，会不会影响正常业务</li>
<li>破坏性测试<ul>
<li>块设备异常是否影响其他iscsi卷的业务</li>
</ul>
</li>
<li>相比IET，有哪些新特性</li>
<li>对比所有TARGET的开源实现，有哪些优势，有无缺点</li>
</ul>
<p>####参考</p>
<ul>
<li><a href="https://www.ibm.com/developerworks/community/blogs/5144904d-5d75-45ed-9d2b-cf1754ee936a/entry/linux_io_target%e4%bb%8b%e7%bb%8d_%e4%b8%80?lang=en" target="_blank" rel="external">Linux-IO Target介绍(一)</a></li>
<li><a href="https://www.ibm.com/developerworks/community/blogs/5144904d-5d75-45ed-9d2b-cf1754ee936a/entry/april_11_2014_12_58_am?lang=en" target="_blank" rel="external">Linux-IO Target介绍(二)</a></li>
<li><a href="http://blog.csdn.net/load2006/article/details/18088445" target="_blank" rel="external">LIO target</a></li>
<li><a href="http://linux-iscsi.org/wiki/LIO" target="_blank" rel="external">LIO</a></li>
<li><a href="http://linux-iscsi.org/wiki/ISCSI" target="_blank" rel="external">ISCSI</a></li>
<li><a href="https://en.wikipedia.org/wiki/LIO_(SCSI_target" target="_blank" rel="external">LIO wikipedia</a>)</li>
<li><a href="http://linux-iscsi.org/wiki/Features" target="_blank" rel="external">Linux SCSI Target Features</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-11-26-lio/" data-id="cin4f0h4s006pl8izc7t1sby8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2014-09-15-rapidly-method-for-clean-directory-with-rsync" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-09-15-rapidly-method-for-clean-directory-with-rsync/" class="article-date">
  <time datetime="2016-04-17T10:13:48.603Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-09-15-rapidly-method-for-clean-directory-with-rsync/">Rapidly method for clean directory with rsync</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>###Methods</p>
<ul>
<li>rm</li>
<li>rsync</li>
</ul>
<p>###Test<br>    [dennis@localhost ttt]$ mkdir empty<br>    [dennis@localhost ttt]$ mkdir tmp/; seq 1 40000 | xargs -I{} touch tmp/file<em>{}<br>    [dennis@localhost ttt]$ mkdir tmp1/; time seq 1 40000 | xargs -I{} touch tmp1/file</em>{} </p>
<pre><code>real    0m28.781s
user    0m0.361s
sys    0m3.091s
[dennis@localhost ttt]$ ls -ld *
drwxrwxr-x. 2 dennis dennis    4096 Sep 15 09:07 empty
drwxrwxr-x. 2 dennis dennis 1114112 Sep 15 09:11 tmp
drwxrwxr-x. 2 dennis dennis 1114112 Sep 15 09:13 tmp1
[dennis@localhost ttt]$ strace -c rsync -a --delete empty/ tmp/
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 98.91    0.001000         100        10         1 select
  1.09    0.000011           2         6         3 wait4
  0.00    0.000000           0        15           read
  0.00    0.000000           0         5           write
  0.00    0.000000           0        21         9 open
  0.00    0.000000           0        20           close
  0.00    0.000000           0         5         3 stat
  0.00    0.000000           0        12           fstat
  0.00    0.000000           0         1           lstat
  0.00    0.000000           0        25           mmap
  0.00    0.000000           0        12           mprotect
  0.00    0.000000           0         6           munmap
  0.00    0.000000           0         6           brk
  0.00    0.000000           0        10           rt_sigaction
  0.00    0.000000           0         1           rt_sigprocmask
  0.00    0.000000           0         1         1 rt_sigreturn
  0.00    0.000000           0         1         1 access
  0.00    0.000000           0         4           socket
  0.00    0.000000           0         4         4 connect
  0.00    0.000000           0         2           socketpair
  0.00    0.000000           0         1           clone
  0.00    0.000000           0         1           execve
  0.00    0.000000           0        11           fcntl
  0.00    0.000000           0         4           getdents
  0.00    0.000000           0         1           getcwd
  0.00    0.000000           0         1           chdir
  0.00    0.000000           0         2           umask
  0.00    0.000000           0         1           geteuid
  0.00    0.000000           0         1           getegid
  0.00    0.000000           0         1           arch_prctl
  0.00    0.000000           0         2           openat
------ ----------- ----------- --------- --------- ----------------
100.00    0.001011                   193        22 total
[dennis@localhost ttt]$ strace -c rm -rf tmp1/
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 79.25    0.035329           1     40001           unlinkat
 17.50    0.007800         186        42           getdents
  3.07    0.001369           7       196           brk
  0.18    0.000082          21         4           munmap
  0.00    0.000000           0         2           read
  0.00    0.000000           0         8         4 open
  0.00    0.000000           0        10           close
  0.00    0.000000           0         4         3 stat
  0.00    0.000000           0         6           fstat
  0.00    0.000000           0         1           lstat
  0.00    0.000000           0         1         1 lseek
  0.00    0.000000           0        11           mmap
  0.00    0.000000           0         4           mprotect
  0.00    0.000000           0         1           ioctl
  0.00    0.000000           0         1         1 access
  0.00    0.000000           0         1           execve
  0.00    0.000000           0         9           fcntl
  0.00    0.000000           0         1           fstatfs
  0.00    0.000000           0         1           arch_prctl
  0.00    0.000000           0         2           openat
  0.00    0.000000           0         1           newfstatat
------ ----------- ----------- --------- --------- ----------------
100.00    0.044580                 40307         9 total
</code></pre><p>###Analyze system call</p>
<ul>
<li><p>rm<br>Do so many system calls, special of unlinkat, it take of 79.25% of time,   </p>
</li>
<li><p>rsync  </p>
</li>
</ul>
<p>###Analyze source code</p>
<ul>
<li><a href="http://rsync.samba.org/" target="_blank" rel="external">rsync</a></li>
</ul>
<p>###Reference</p>
<ul>
<li><a href="http://www.quora.com/How-can-someone-rapidly-delete-400-000-files" target="_blank" rel="external">How can someone rapidly delete 400,000 files?</a></li>
<li><a href="http://blog.chinaunix.net/uid-10705106-id-3879288.html" target="_blank" rel="external">为什么rsync能够快速删除400000文件</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-09-15-rapidly-method-for-clean-directory-with-rsync/" data-id="cin4f0h4r006ol8izfp1fn6ek" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2014-09-08-linux-performace-tools" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-09-08-linux-performace-tools/" class="article-date">
  <time datetime="2016-04-17T10:13:48.601Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-09-08-linux-performace-tools/">linux performace tools</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>###</p>
<p><img src="/assets/image/posts/perf/linux_benchmarking_tools.png" alt="linux benchmarking tools"></p>
<p><img src="/assets/image/posts/perf/linux_observability_sar.png" alt="linux observability sar"></p>
<p><img src="/assets/image/posts/perf/linux_tuning_tools.png" alt="linux tuning tools"></p>
<p>###Tools: Basic</p>
<ul>
<li>uptime</li>
<li>top or htop</li>
<li>mpstat</li>
<li>iostat</li>
<li>vmstat</li>
<li>free </li>
<li>ping</li>
<li>nicstat</li>
<li>dstat</li>
</ul>
<p>###Tools: Intermediate</p>
<ul>
<li>sar</li>
<li>netstat</li>
<li>pidstat</li>
<li>strace</li>
<li>tcpdump</li>
<li>blktrace</li>
<li>iotop</li>
<li>slabtop</li>
<li>sysctl</li>
<li>/proc</li>
</ul>
<p>###Tools: Advanced</p>
<ul>
<li>perf<ul>
<li><code>perf record program [program_option]</code></li>
<li><code>perf report</code></li>
</ul>
</li>
<li>DTrace</li>
<li>SystemTap</li>
<li>and more…<ul>
<li>ps</li>
<li>pmap</li>
<li>traceroute</li>
<li>ntop</li>
<li>ss</li>
<li>lsof</li>
<li>oprofile</li>
<li>gprof</li>
<li>kcachegrind</li>
<li>valgrind</li>
<li>google profiler</li>
<li>nfsiostat</li>
<li>cifsiostat</li>
<li>latencytop</li>
<li>powertop</li>
<li>LLTng</li>
<li>ktap</li>
</ul>
</li>
</ul>
<p>###Reference</p>
<ul>
<li><a href="http://www.brendangregg.com/linuxperf.html" target="_blank" rel="external">Linux Performance</a></li>
<li><a href="http://www.slideshare.net/brendangregg/linux-performance-analysis-and-tools" target="_blank" rel="external">Linux performance analysis and tools</a></li>
<li><a href="http://www.vpsee.com/tag/performance/" target="_blank" rel="external">Tag: performance</a></li>
<li><a href="https://perf.wiki.kernel.org/index.php/Tutorial" target="_blank" rel="external">perf wiki</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-09-08-linux-performace-tools/" data-id="cin4f0h4p006ml8izd4hp2qz6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/valgrind/">valgrind</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2014-09-07-sync" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-09-07-sync/" class="article-date">
  <time datetime="2016-04-17T10:13:48.600Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-09-07-sync/">sync</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>###Introduce<br>sync, linux command, using to write any data buffer in memory out to disk.</p>
<p>It do nothing, but exercise the ‘sync’ system call</p>
<p>So, if we want to study what the ‘sync’ really do, go in the kernel.</p>
<p>###sync command<br>File: coreutils-8.9/src/sync.c</p>
<pre><code>int
main (int argc, char **argv)
{
  initialize_main (&amp;argc, &amp;argv);
  set_program_name (argv[0]);
  setlocale (LC_ALL, &quot;&quot;);
  bindtextdomain (PACKAGE, LOCALEDIR);
  textdomain (PACKAGE);

  atexit (close_stdout);

  parse_long_options (argc, argv, PROGRAM_NAME, PACKAGE, Version,
                      usage, AUTHORS, (char const *) NULL);
  if (getopt_long (argc, argv, &quot;&quot;, NULL, NULL) != -1)
    usage (EXIT_FAILURE);

  if (optind &lt; argc)
    error (0, 0, _(&quot;ignoring all arguments&quot;));

  sync ();
  exit (EXIT_SUCCESS);
}
</code></pre><p>Do nothing, but do system call <code>sync()</code></p>
<p>###sync architecture in kernel</p>
<p>system call <code>sync()</code> is defined in fs/sync.c</p>
<pre><code>/*
 * sync everything.  Start out by waking pdflush, because that writes back
 * all queues in parallel.
 */
SYSCALL_DEFINE0(sync)
{
    wakeup_flusher_threads(0);
    sync_filesystems(0);
    sync_filesystems(1);
    if (unlikely(laptop_mode))
        laptop_sync_completion();
    return 0;
}
</code></pre><p><code>sync</code> call <code>sync_filesystems</code>  </p>
<pre><code>static void sync_filesystems(int wait)
{
    struct super_block *sb;
    static DEFINE_MUTEX(mutex);

    mutex_lock(&amp;mutex);        /* Could be down_interruptible */
    spin_lock(&amp;sb_lock);
    list_for_each_entry(sb, &amp;super_blocks, s_list)
        sb-&gt;s_need_sync = 1;

restart:
    list_for_each_entry(sb, &amp;super_blocks, s_list) {
        if (!sb-&gt;s_need_sync)
            continue;
        sb-&gt;s_need_sync = 0;
        sb-&gt;s_count++;
        spin_unlock(&amp;sb_lock);

        down_read(&amp;sb-&gt;s_umount);
        if (!(sb-&gt;s_flags &amp; MS_RDONLY) &amp;&amp; sb-&gt;s_root &amp;&amp; sb-&gt;s_bdi)
            __sync_filesystem(sb, wait);
        up_read(&amp;sb-&gt;s_umount);

        /* restart only when sb is no longer on the list */
        spin_lock(&amp;sb_lock);
        if (__put_super_and_need_restart(sb))
            goto restart;
    }
    spin_unlock(&amp;sb_lock);
    mutex_unlock(&amp;mutex);
}
</code></pre><p><code>sync_filesystems</code> call <code>__sync_filesystem</code> </p>
<pre><code>static int __sync_filesystem(struct super_block *sb, int wait)
{
    /*
     * This should be safe, as we require bdi backing to actually
     * write out data in the first place
     */
    if (!sb-&gt;s_bdi)
        return 0;

    /* Avoid doing twice syncing and cache pruning for quota sync */
    if (!wait) {
        writeout_quota_sb(sb, -1);
        writeback_inodes_sb(sb);
    } else {
        sync_quota_sb(sb, -1);
        sync_inodes_sb(sb);
    }
    if (sb-&gt;s_op-&gt;sync_fs)
        sb-&gt;s_op-&gt;sync_fs(sb, wait);
    return __sync_blockdev(sb-&gt;s_bdev, wait);
}
</code></pre><p><code>__sync_filesystem</code> call <code>sb-&gt;s_op-&gt;sync_fs(sb, wait)</code>, each filesystem should<br>implement the sync_fs()</p>
<p>###when to use</p>
<ol>
<li>before shutdown computer, using <code>sync</code> more than twice</li>
<li>after write big file to disk, such as using command <code>cp</code></li>
<li>to be continue</li>
</ol>
<p>###sync,fsync,fdatasync</p>
<ul>
<li>sync, add the modified buffer to write_queue, then return immediately, not wait<br>for the reality disk writed.</li>
<li>fsync, used for single file with specify file description,and wait the disk write finish.</li>
<li>fdatasync, similar to fsync, but just do effect to the data part. fsync make<br>effect to data and file property.</li>
</ul>
<p>###special application</p>
<ol>
<li>How if I want to sync from serval Virtual Disks, and ignore serval VDs</li>
<li>To be continue</li>
</ol>
<p>###Reference</p>
<ul>
<li>man sync</li>
<li>info coreutils ‘sync invocation’ </li>
<li>kernel code</li>
<li><a href="ftp://ftp.gnu.org/gnu/coreutils/coreutils-8.9.tar.xz" target="_blank" rel="external">coreutils-8.9</a></li>
<li><a href="http://jesserei.blog.163.com/blog/static/121411689201032015129673/" target="_blank" rel="external">sync、fsync和fdatasync函数</a></li>
<li><a href="http://www.2cto.com/os/201204/126687.html" target="_blank" rel="external">缓存同步操作–sys_sync系统调用</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-09-07-sync/" data-id="cin4f0h4o006ll8iznza8azok" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2014-09-06-bash-trap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/2014-09-06-bash-trap/" class="article-date">
  <time datetime="2016-04-17T10:13:48.599Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/2014-09-06-bash-trap/">bash trap</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>From <a href="http://blog.charlee.li/bash-pitfalls/" target="_blank" rel="external">http://blog.charlee.li/bash-pitfalls/</a></p>
<p>感谢fcicq，他的new 30 days系列为我们带来了不少好文章。</p>
<p>今天想分析的是这篇Bash Pitfalls, 介绍了一些bash编程中的经典错误。fcicq说可能不适<br>合初学者，而我认为， 正是bash编程的初学者才应该好好阅读一下这篇文章。</p>
<p>下面就逐个分析一下这篇文章中提到的错误。不是完全的翻译，有些没用的话就略过了，<br>有些地方则加了些注释。</p>
<ul>
<li>1.for i in `ls *.mp3`</li>
</ul>
<p>常见的错误写法：</p>
<pre><code>for i in `ls *.mp3`; do     # Wrong!
</code></pre><p>为什么错误呢？因为for…in语句是按照空白来分词的，包含空格的文件名会被拆成多个词。<br>如遇到 01 - Don’t Eat the Yellow Snow.mp3 时，i的值会依次取 01，-，Don’t，等等。</p>
<p>用双引号也不行，它会将ls *.mp3的全部结果当成一个词来处理。</p>
<pre><code>for i in &quot;`ls *.mp3`&quot;; do   # Wrong!
</code></pre><p>正确的写法是</p>
<pre><code>for i in *.mp3; do
</code></pre><ul>
<li>2.<code>cp $file $target</code></li>
</ul>
<p>这句话基本上正确，但同样有空格分词的问题。所以应当用双引号：</p>
<pre><code>cp &quot;$file&quot; &quot;$target&quot;
</code></pre><p>但是如果凑巧文件名以 - 开头，这个文件名会被 cp 当作命令行选项来处理，依旧很头疼。<br>可以试试下面这个。</p>
<pre><code>cp -- &quot;$file&quot; &quot;$target&quot;
</code></pre><p>运气差点的再碰上一个不支持 – 选项的系统，那只能用下面的方法了：使每个变量都以目录开头。</p>
<pre><code>for i in ./*.mp3; do
  cp &quot;$i&quot; /target
  ...
</code></pre><ul>
<li>3.<code>[ $foo = &quot;bar&quot; ]</code></li>
</ul>
<p>当$foo为空时，上面的命令就变成了</p>
<pre><code>[ = &quot;bar&quot; ]
</code></pre><p>类似地，当$foo包含空格时：</p>
<pre><code>[ multiple words here = &quot;bar&quot; ]
</code></pre><p>两者都会出错。所以应当用双引号将变量括起来：</p>
<pre><code>[ &quot;$foo&quot; = bar ]      # 几乎完美了。
</code></pre><p>但是当$foo以 - 开头时依然会有问题。 在较新的bash中你可以用下面的方法来代替，<br>[[ 关键字能正确处理空白、空格、带横线等问题。</p>
<pre><code>[[ $foo = bar ]]      # 正确
</code></pre><p>旧版本bash中可以用这个技巧（虽然不好理解）：</p>
<pre><code>[ x&quot;$foo&quot; = xbar ]    # 正确
</code></pre><p>或者干脆把变量放在右边，因为 [ 命令的等号右边即使是空白或是横线开头，依然能正常<br>工作。 （Java编程风格中也有类似的做法，虽然目的不一样。）</p>
<pre><code>[ bar = &quot;$foo&quot; ]      # 正确
</code></pre><ul>
<li>4.cd `dirname “$f”`</li>
</ul>
<p>同样也存在空格问题。那么加上引号吧。</p>
<pre><code>cd &quot;`dirname &quot;$f&quot;`&quot;
</code></pre><p>问题来了，是不是写错了？由于双引号的嵌套，你会认为<code>dirname 是第一个字符串，</code>是<br>第二个字符串。 错了，那是C语言。在bash中，命令替换（反引号``中的内容）里面的双引<br>号会被正确地匹配到一起， 不用特意去转义。</p>
<p>$()语法也相同，如下面的写法是正确的。</p>
<pre><code>cd &quot;$(dirname &quot;$f&quot;)&quot;
</code></pre><ul>
<li>5.<code>[ &quot;$foo&quot; = bar &amp;&amp; &quot;$bar&quot; = foo ]</code></li>
</ul>
<p>[ 中不能使用 &amp;&amp; 符号！因为 [ 的实质是 test 命令，&amp;&amp; 会把这一行分成两个命令的。应<br>该用以下的写法。</p>
<pre><code>[ bar = &quot;$foo&quot; -a foo = &quot;$bar&quot; ]       # Right!
[ bar = &quot;$foo&quot; ] &amp;&amp; [ foo = &quot;$bar&quot; ]   # Also right!
[[ $foo = bar &amp;&amp; $bar = foo ]]         # Also right!
</code></pre><ul>
<li>6.<code>[ $foo &gt; 7 ]</code></li>
</ul>
<p>很可惜 [[ 只适用于字符串，不能做数字比较。数字比较应当这样写：</p>
<pre><code>(( $foo &gt; 7 ))
</code></pre><p>或者用经典的写法：</p>
<pre><code>[ $foo -gt 7 ]
</code></pre><p>但上述使用 -gt 的写法有个问题，那就是当 $foo 不是数字时就会出错。你必须做好类型检验。</p>
<p>这样写也行。</p>
<pre><code>[[ $foo -gt 7 ]]
</code></pre><ul>
<li>7.<code>grep foo bar | while read line; do ((count++)); done</code></li>
</ul>
<p>这行代码数出bar文件中包含foo的行数，虽然很麻烦（等同于<code>grep -c foo bar</code>或者 <code>grep 
foo bar | wc -l</code>）。 乍一看没有问题，但执行之后count变量却没有值。因为管道中的每<br>个命令都放到一个新的子shell中执行， 所以子shell中定义的count变量无法传递出来。</p>
<ul>
<li>8.<code>if [grep foo myfile]</code></li>
</ul>
<p>初学者常犯的错误，就是将 if 语句后面的 [ 当作if语法的一部分。实际上它是一个命令<br>，相当于 test 命令， 而不是 if 语法。这一点C程序员特别应当注意。</p>
<p>if 会将 if 到 then 之间的所有命令的返回值当作判断条件。因此上面的语句应当写成</p>
<pre><code>if grep foo myfile &gt; /dev/null; then
</code></pre><ul>
<li>9.<code>if [bar=&quot;$foo&quot;]</code></li>
</ul>
<p>同样，[ 是个命令，不是 if 语句的一部分，所以要注意空格。</p>
<pre><code>if [ bar = &quot;$foo&quot; ]
</code></pre><ul>
<li>10.<code>if [ [ a = b ] &amp;&amp; [ c = d ] ]</code></li>
</ul>
<p>同样的问题，[ 不是 if 语句的一部分，当然也不是改变逻辑判断的括号。它是一个命令。<br>可能C程序员比较容易犯这个错误？</p>
<pre><code>if [ a = b ] &amp;&amp; [ c = d ]        # 正确
</code></pre><ul>
<li>11.<code>cat file | sed s/foo/bar/ &gt; file</code></li>
</ul>
<p>你不能在同一条管道操作中同时读写一个文件。根据管道的实现方式，file要么被截断成0<br>字节，要么会无限增长直到填满整个硬盘。 如果想改变原文件的内容，只能先将输出写到<br>临时文件中再用mv命令。</p>
<pre><code>sed &apos;s/foo/bar/g&apos; file &gt; tmpfile &amp;&amp; mv tmpfile file
</code></pre><ul>
<li>12.<code>echo $foo</code></li>
</ul>
<p>这句话还有什么错误码？一般来说是正确的，但下面的例子就有问题了。</p>
<pre><code>MSG=&quot;Please enter a file name of the form *.zip&quot;
echo $MSG         # 错误！
</code></pre><p>如果恰巧当前目录下有zip文件，就会显示成</p>
<pre><code>Please enter a file name of the form freenfss.zip lw35nfss.zip
</code></pre><p>所以即使是echo也别忘记给变量加引号。</p>
<ul>
<li>13.<code>$foo=bar</code></li>
</ul>
<p>变量赋值时无需加 $ 符号——这不是Perl或PHP。</p>
<ul>
<li>14.<code>foo = bar</code></li>
</ul>
<p>变量赋值时等号两侧不能加空格——这不是C语言。</p>
<ul>
<li>15.<code>echo &lt;&lt;EOF</code></li>
</ul>
<p>here document是个好东西，它可以输出成段的文字而不用加引号也不用考虑换行符的处理<br>问题。 不过here document输出时应当使用cat而不是echo。</p>
<pre><code># This is wrong:
echo &lt;&lt;EOF
Hello world
EOF


# This is right:
cat &lt;&lt;EOF
Hello world
EOF
</code></pre><ul>
<li>16.<code>su -c &#39;some command&#39;</code></li>
</ul>
<p>原文的意思是，这条基本上正确，但使用者的目的是要将 -c ‘some command’ 传给shell。<br>而恰好 su 有个 -c 参数，所以su 只会将 ‘some command’ 传给shell。所以应该这么写：</p>
<pre><code>su root -c &apos;some command&apos;
</code></pre><p>但是在我的平台上，man su 的结果中关于 -c 的解释为</p>
<pre><code>-c, --commmand=COMMAND
            pass a single COMMAND to the shell with -c
</code></pre><p>也就是说，-c ‘some command’ 同样会将 -c ‘some command’ 这样一个字符串传递给shell<br>， 和这条就不符合了。不管怎样，先将这一条写在这里吧。</p>
<ul>
<li>17.<code>cd /foo; bar</code></li>
</ul>
<p>cd有可能会出错，出错后 bar 命令就会在你预想不到的目录里执行了。所以一定要记得判断cd的返回值。</p>
<pre><code>cd /foo &amp;&amp; bar
</code></pre><p>如果你要根据cd的返回值执行多条命令，可以用 ||。</p>
<pre><code>cd /foo || exit 1;
bar
baz
</code></pre><p>关于目录的一点题外话，假设你要在shell程序中频繁变换工作目录，如下面的代码：</p>
<pre><code>find ... -type d | while read subdir; do
  cd &quot;$subdir&quot; &amp;&amp; whatever &amp;&amp; ... &amp;&amp; cd -
done
</code></pre><p>不如这样写：</p>
<pre><code>find ... -type d | while read subdir; do
  (cd &quot;$subdir&quot; &amp;&amp; whatever &amp;&amp; ...)
done
</code></pre><p>括号会强制启动一个子shell，这样在这个子shell中改变工作目录不会影响父shell（执行<br>这个脚本的shell）， 就可以省掉cd - 的麻烦。</p>
<p>你也可以灵活运用 pushd、popd、dirs 等命令来控制工作目录。</p>
<ul>
<li>18.<code>[ bar == &quot;$foo&quot; ]</code></li>
</ul>
<p>[ 命令中不能用 ==，应当写成</p>
<pre><code>[ bar = &quot;$foo&quot; ] &amp;&amp; echo yes
[[ bar == $foo ]] &amp;&amp; echo yes
</code></pre><ul>
<li>19.<code>for i in {1..10}; do ./something &amp;; done</code></li>
</ul>
<p>&amp; 后面不应该再放 ; ，因为 &amp; 已经起到了语句分隔符的作用，无需再用;。</p>
<pre><code>for i in {1..10}; do ./something &amp; done
</code></pre><ul>
<li>20.<code>cmd1 &amp;&amp; cmd2 || cmd3</code></li>
</ul>
<p>有人喜欢用这种格式来代替 if…then…else 结构，但其实并不完全一样。如果cmd2返回<br>一个非真值，那么cmd3则会被执行。 所以还是老老实实地用 if cmd1; then cmd2; else<br>cmd3 为好。</p>
<ul>
<li>21.UTF-8的BOM(Byte-Order Marks)问题</li>
</ul>
<p>UTF-8编码可以在文件开头用几个字节来表示编码的字节顺序，这几个字节称为BOM。但Unix<br>格式的UTF-8编码不需要BOM。 多余的BOM会影响shell解析，特别是开头的 #!/bin/sh 之类<br>的指令将会无法识别。</p>
<p>MS-DOS格式的换行符(CRLF)也存在同样的问题。如果你将shell程序保存成DOS格式，脚本就无法执行了。</p>
<pre><code>$ ./dos
-bash: ./dos: /bin/sh^M: bad interpreter: No such file or directory
</code></pre><ul>
<li>22.<code>echo &quot;Hello World!&quot;</code></li>
</ul>
<p>交互执行这条命令会产生以下的错误：</p>
<pre><code>-bash: !&quot;: event not found
</code></pre><p>因为 !” 会被当作命令行历史替换的符号来处理。不过在shell脚本中没有这样的问题。</p>
<p>不幸的是，你无法使用转义符来转义!：</p>
<pre><code>$ echo &quot;hi\!&quot;
hi\!
</code></pre><p>解决方案之一，使用单引号，即</p>
<pre><code>$ echo &apos;Hello, world!&apos;
</code></pre><p>如果你必须使用双引号，可以试试通过 set +H 来取消命令行历史替换。</p>
<pre><code>set +H
echo &quot;Hello, world!&quot;
</code></pre><ul>
<li>23.<code>for arg in $*</code></li>
</ul>
<p>$*表示所有命令行参数，所以你可能想这样写来逐个处理参数，但参数中包含空格时就会失败。如：</p>
<pre><code>#!/bin/bash
# Incorrect version
for x in $*; do
  echo &quot;parameter: &apos;$x&apos;&quot;
done


$ ./myscript &apos;arg 1&apos; arg2 arg3
parameter: &apos;arg&apos;
parameter: &apos;1&apos;
parameter: &apos;arg2&apos;
parameter: &apos;arg3&apos;
</code></pre><p>正确的方法是使用 $@。</p>
<pre><code>#!/bin/bash
# Correct version
for x in &quot;$@&quot;; do
  echo &quot;parameter: &apos;$x&apos;&quot;
done


$ ./myscript &apos;arg 1&apos; arg2 arg3
parameter: &apos;arg 1&apos;
parameter: &apos;arg2&apos;
parameter: &apos;arg3&apos;
</code></pre><p>在 bash 的手册中对 $* 和 $@ 的说明如下：</p>
<pre><code>*    Expands to the positional parameters, starting from one.  
     When the expansion occurs within double quotes, it 
     expands to a single word with the value of each parameter 
     separated by the first character of the IFS special variable.  
     That is, &quot;$*&quot; is equivalent to &quot;$1c$2c...&quot;,
@    Expands to the positional parameters, starting from one. 
     When the expansion occurs within double quotes, each 
     parameter expands to a separate word.  That  is,  &quot;$@&quot;  
     is equivalent to &quot;$1&quot; &quot;$2&quot; ...  
</code></pre><p>可见，不加引号时 $<em> 和 $@ 是相同的，但$</em> 会被扩展成一个字符串，而 $@ 会 被扩展成每一个参数。</p>
<ul>
<li>24.<code>function foo()</code></li>
</ul>
<p>在bash中没有问题，但其他shell中有可能出错。不要把 function 和括号一起使用。 最为<br>保险的做法是使用括号，即</p>
<pre><code>foo() {
  ...
}
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/17/2014-09-06-bash-trap/" data-id="cin4f0h4n006kl8izrxbruq11" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/6/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/debug/">debug</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/math/">math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/windows/">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ARP/">ARP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Auto-Compile/">Auto Compile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Batch-File/">Batch File</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Emacs/">Emacs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FAQ/">FAQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ICMP/">ICMP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IRC/">IRC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NetworkStack/">NetworkStack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Notepad/">Notepad++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Translation/">Translation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WinIO/">WinIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/api/">api</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arp/">arp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/auto-compile/">auto compile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/batch/">batch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blat/">blat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dot/">dot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exploit/">exploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flowchart/">flowchart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gedit/">gedit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google/">google</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/graphviz/">graphviz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hardware-monitor/">hardware monitor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jekyll/">jekyll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lisp/">lisp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/">mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mail/">mail</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mathematician/">mathematician</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maxima/">maxima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mtrace/">mtrace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/net-snmp/">net-snmp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netbios/">netbios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/novels/">novels</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/opennebula/">opennebula</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/org-mode/">org mode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pandoc/">pandoc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/plugin/">plugin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raid/">raid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsync/">rsync</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sed/">sed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skype/">skype</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/source-analyze/">source analyze</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlite/">sqlite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/study/">study</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svn/">svn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tunnel/">tunnel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/valgrind/">valgrind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vi/">vi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wget/">wget</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wifi/">wifi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wireless-tools/">wireless-tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wpa-supplicant/">wpa_supplicant</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xml/">xml</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ARP/" style="font-size: 10px;">ARP</a> <a href="/tags/Auto-Compile/" style="font-size: 10px;">Auto Compile</a> <a href="/tags/Batch-File/" style="font-size: 10px;">Batch File</a> <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/Emacs/" style="font-size: 10px;">Emacs</a> <a href="/tags/FAQ/" style="font-size: 10px;">FAQ</a> <a href="/tags/ICMP/" style="font-size: 10px;">ICMP</a> <a href="/tags/IRC/" style="font-size: 10px;">IRC</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/NetworkStack/" style="font-size: 12.5px;">NetworkStack</a> <a href="/tags/Notepad/" style="font-size: 10px;">Notepad++</a> <a href="/tags/Translation/" style="font-size: 17.5px;">Translation</a> <a href="/tags/WinIO/" style="font-size: 10px;">WinIO</a> <a href="/tags/api/" style="font-size: 10px;">api</a> <a href="/tags/arp/" style="font-size: 10px;">arp</a> <a href="/tags/auto-compile/" style="font-size: 10px;">auto compile</a> <a href="/tags/awk/" style="font-size: 12.5px;">awk</a> <a href="/tags/batch/" style="font-size: 20px;">batch</a> <a href="/tags/blat/" style="font-size: 12.5px;">blat</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/dot/" style="font-size: 10px;">dot</a> <a href="/tags/exploit/" style="font-size: 10px;">exploit</a> <a href="/tags/flowchart/" style="font-size: 10px;">flowchart</a> <a href="/tags/gedit/" style="font-size: 10px;">gedit</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/github/" style="font-size: 12.5px;">github</a> <a href="/tags/google/" style="font-size: 10px;">google</a> <a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a> <a href="/tags/hardware-monitor/" style="font-size: 10px;">hardware monitor</a> <a href="/tags/javascript/" style="font-size: 10px;">javascript</a> <a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/kvm/" style="font-size: 12.5px;">kvm</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/lisp/" style="font-size: 10px;">lisp</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/mail/" style="font-size: 10px;">mail</a> <a href="/tags/mathematician/" style="font-size: 10px;">mathematician</a> <a href="/tags/maxima/" style="font-size: 10px;">maxima</a> <a href="/tags/mtrace/" style="font-size: 10px;">mtrace</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/net-snmp/" style="font-size: 10px;">net-snmp</a> <a href="/tags/netbios/" style="font-size: 10px;">netbios</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/novels/" style="font-size: 10px;">novels</a> <a href="/tags/opennebula/" style="font-size: 10px;">opennebula</a> <a href="/tags/org-mode/" style="font-size: 10px;">org mode</a> <a href="/tags/pandoc/" style="font-size: 10px;">pandoc</a> <a href="/tags/plugin/" style="font-size: 10px;">plugin</a> <a href="/tags/raid/" style="font-size: 10px;">raid</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/sed/" style="font-size: 12.5px;">sed</a> <a href="/tags/shell/" style="font-size: 17.5px;">shell</a> <a href="/tags/skype/" style="font-size: 12.5px;">skype</a> <a href="/tags/source-analyze/" style="font-size: 10px;">source analyze</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/study/" style="font-size: 10px;">study</a> <a href="/tags/svn/" style="font-size: 17.5px;">svn</a> <a href="/tags/tunnel/" style="font-size: 10px;">tunnel</a> <a href="/tags/valgrind/" style="font-size: 12.5px;">valgrind</a> <a href="/tags/vi/" style="font-size: 10px;">vi</a> <a href="/tags/vim/" style="font-size: 17.5px;">vim</a> <a href="/tags/wget/" style="font-size: 10px;">wget</a> <a href="/tags/wifi/" style="font-size: 10px;">wifi</a> <a href="/tags/wireless-tools/" style="font-size: 10px;">wireless-tools</a> <a href="/tags/wpa-supplicant/" style="font-size: 10px;">wpa_supplicant</a> <a href="/tags/xml/" style="font-size: 10px;">xml</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/04/17/2016-04-13-malloc/">malloc</a>
          </li>
        
          <li>
            <a href="/2016/04/17/2016-03-12-performance-optimization-of-cplusplus/">performance optimization of C++</a>
          </li>
        
          <li>
            <a href="/2016/04/17/2016-03-09-stack-trace-when-program-crash/">stack trace when program crash</a>
          </li>
        
          <li>
            <a href="/2016/04/17/2016-03-09-database-knowledges/">Database knowledges</a>
          </li>
        
          <li>
            <a href="/2016/04/17/2016-03-09-check-pow-overflow/">check pow overflow</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>